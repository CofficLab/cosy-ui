# 步骤 08.5：测试和文档

## 目标
完成项目的测试和文档编写。

## 任务清单
- [ ] 创建API测试
- [ ] 编写使用文档
- [ ] 添加示例说明

## 执行步骤

### 1. 创建 README 文档

**创建文件**: `packages/cosy-framework-example/README.md`

```markdown
# Basic API Example

这是一个使用 Cosy Framework 构建的基础 API 示例项目，展示了框架的核心功能。

## 功能特性

- 🚀 基于 TypeScript 的现代框架
- 🔧 依赖注入容器
- 🛣️ 灵活的路由系统
- 🔒 中间件支持
- ⚙️ 配置管理
- 📝 RESTful API 设计
- 🧪 完整的测试覆盖

## 项目结构

```
src/
├── controllers/     # 控制器（装饰器风格）
├── services/        # 业务逻辑服务
├── middleware/      # 自定义中间件
├── types/          # TypeScript 类型定义
├── app.ts          # 应用配置
└── server.ts       # 服务器启动

config/             # 配置文件
├── app.json        # 基础配置
├── development.json # 开发环境配置
└── production.json  # 生产环境配置

tests/              # 测试文件
```

## 安装和运行

### 1. 安装依赖

```bash
npm install
```

### 2. 复制环境变量

```bash
cp .env.example .env
```

### 3. 开发模式运行

```bash
npm run dev
```

### 4. 构建和生产运行

```bash
npm run build
npm start
```

## API 文档

### 健康检查

```http
GET /health
```

返回应用健康状态。

### 用户 API

#### 获取所有用户

```http
GET /api/v1/users
```

#### 获取单个用户

```http
GET /api/v1/users/{id}
```

#### 创建用户

```http
POST /api/v1/users
Content-Type: application/json

{
  "name": "John Doe",
  "email": "john@example.com"
}
```

#### 更新用户

```http
PUT /api/v1/users/{id}
Content-Type: application/json

{
  "name": "John Smith",
  "email": "johnsmith@example.com"
}
```

#### 删除用户

```http
DELETE /api/v1/users/{id}
```

### 文章 API（需要认证）

所有文章 API 需要在请求头中包含认证令牌：

```
Authorization: Bearer valid-token
```

#### 获取所有文章

```http
GET /api/v1/posts
Authorization: Bearer valid-token
```

#### 创建文章

```http
POST /api/v1/posts
Authorization: Bearer valid-token
Content-Type: application/json

{
  "title": "My First Post",
  "content": "This is the content of my first post."
}
```

## 测试

### 运行单元测试

```bash
npm test
```

### 运行 API 集成测试

```bash
npm run test:api
```

## 示例请求

### 使用 curl

```bash
# 健康检查
curl http://localhost:3000/health

# 获取用户列表
curl http://localhost:3000/api/v1/users

# 创建用户
curl -X POST http://localhost:3000/api/v1/users \
  -H "Content-Type: application/json" \
  -d '{"name":"Alice","email":"alice@example.com"}'

# 获取文章（需要认证）
curl http://localhost:3000/api/v1/posts \
  -H "Authorization: Bearer valid-token"

# 创建文章（需要认证）
curl -X POST http://localhost:3000/api/v1/posts \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer valid-token" \
  -d '{"title":"Hello World","content":"This is my first post"}'
```

## 配置

应用配置通过以下方式管理：

1. **配置文件**: `config/` 目录下的 JSON 文件
2. **环境变量**: 通过 `.env` 文件或系统环境变量
3. **运行时配置**: 通过代码动态设置

### 环境变量优先级

环境变量 > 环境特定配置文件 > 基础配置文件 > 默认值

## 扩展功能

这个示例展示了 Cosy Framework 的基础功能。你可以基于此示例添加：

- 数据库集成（PostgreSQL、MySQL、MongoDB）
- 认证和授权（JWT、OAuth）
- 文件上传处理
- 缓存（Redis）
- 任务队列
- WebSocket 支持
- 静态文件服务
- API 文档生成
- 日志管理
- 监控和指标

## 许可证

MIT License
```

### 2. 创建 API 测试

**创建文件**: `packages/cosy-framework-example/tests/api.test.ts`

```typescript
import { describe, it, expect, beforeAll, afterAll } from 'vitest'
import { startServer } from '../src/server'
import { Application } from '@coffic/cosy-framework'
import { HttpContext, HttpStatus } from '@coffic/cosy-framework/http'

describe('Basic API Integration Tests', () => {
  let app: Application

  beforeAll(async () => {
    app = await startServer()
  })

  afterAll(async () => {
    if (app.isRunning()) {
      await app.stop()
    }
  })

  describe('Health Check', () => {
    it('should return health status', async () => {
      const context = HttpContext.create({ method: 'GET', url: '/health' })
      const response = await app.handle(context.request)

      expect(response.getStatus()).toBe(HttpStatus.OK)
      
      const body = JSON.parse(response.getContent())
      expect(body).toMatchObject({
        status: 'ok',
        timestamp: expect.any(String),
        uptime: expect.any(Number)
      })
    })
  })

  describe('User API', () => {
    it('should get all users', async () => {
      const context = HttpContext.create({ method: 'GET', url: '/api/v1/users' })
      const response = await app.handle(context.request)

      expect(response.getStatus()).toBe(HttpStatus.OK)
      
      const body = JSON.parse(response.getContent())
      expect(body).toMatchObject({
        users: expect.any(Array),
        total: expect.any(Number)
      })
      expect(body.users.length).toBeGreaterThan(0)
    })

    it('should get user by id', async () => {
      const context = HttpContext.create({ method: 'GET', url: '/api/v1/users/1' })
      const response = await app.handle(context.request)

      expect(response.getStatus()).toBe(HttpStatus.OK)
      
      const body = JSON.parse(response.getContent())
      expect(body).toMatchObject({
        user: {
          id: 1,
          name: expect.any(String),
          email: expect.any(String),
          createdAt: expect.any(String)
        }
      })
    })

    it('should create new user', async () => {
      const userData = {
        name: 'Test User',
        email: 'test@example.com'
      }

      const context = HttpContext.create({
        method: 'POST',
        url: '/api/v1/users',
        body: userData
      })
      const response = await app.handle(context.request)

      expect(response.getStatus()).toBe(HttpStatus.OK)
      
      const body = JSON.parse(response.getContent())
      expect(body).toMatchObject({
        user: {
          id: expect.any(Number),
          name: userData.name,
          email: userData.email,
          createdAt: expect.any(String)
        },
        message: 'User created successfully'
      })
    })
  })

  describe('Post API (Authenticated)', () => {
    it('should require authentication', async () => {
      const context = HttpContext.create({ method: 'GET', url: '/api/v1/posts' })
      const response = await app.handle(context.request)

      expect(response.getStatus()).toBe(HttpStatus.UNAUTHORIZED)
      
      const body = JSON.parse(response.getContent())
      expect(body.error).toContain('Authorization header required')
    })

    it('should get posts with valid token', async () => {
      const context = HttpContext.create({
        method: 'GET',
        url: '/api/v1/posts',
        headers: {
          authorization: 'Bearer valid-token'
        }
      })
      const response = await app.handle(context.request)

      expect(response.getStatus()).toBe(HttpStatus.OK)
      
      const body = JSON.parse(response.getContent())
      expect(body).toMatchObject({
        posts: expect.any(Array),
        total: expect.any(Number)
      })
    })

    it('should create post with valid token', async () => {
      const postData = {
        title: 'Test Post',
        content: 'This is a test post content.'
      }

      const context = HttpContext.create({
        method: 'POST',
        url: '/api/v1/posts',
        headers: {
          authorization: 'Bearer valid-token'
        },
        body: postData
      })
      const response = await app.handle(context.request)

      expect(response.getStatus()).toBe(HttpStatus.OK)
      
      const body = JSON.parse(response.getContent())
      expect(body).toMatchObject({
        post: {
          id: expect.any(Number),
          title: postData.title,
          content: postData.content,
          authorId: expect.any(Number),
          createdAt: expect.any(String)
        },
        message: 'Post created successfully'
      })
    })
  })
})
```

### 3. 创建 API 文档

**创建文件**: `packages/cosy-framework-example/docs/api.md`

```markdown
# API 文档

## 概述

这是 Cosy Framework Basic API Example 的 API 文档。所有 API 都遵循 RESTful 设计原则。

## 基础信息

- 基础 URL: `http://localhost:3000`
- API 版本: v1
- API 前缀: `/api/v1`

## 认证

部分 API 需要认证。认证通过 Bearer Token 实现：

```http
Authorization: Bearer valid-token
```

## 响应格式

所有响应都使用 JSON 格式，包含以下字段：

- 成功响应：
  ```json
  {
    "data": {}, // 响应数据
    "message": "操作成功" // 可选的成功消息
  }
  ```

- 错误响应：
  ```json
  {
    "error": "错误信息",
    "stack": "错误堆栈（仅在开发模式）"
  }
  ```

## API 端点

### 健康检查

#### GET /health

检查应用程序的健康状态。

**响应示例**：
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "uptime": 123.456
}
```

### 用户管理

#### GET /api/v1/users

获取所有用户列表。

**响应示例**：
```json
{
  "users": [
    {
      "id": 1,
      "name": "John Doe",
      "email": "john@example.com",
      "createdAt": "2024-01-01T00:00:00.000Z"
    }
  ],
  "total": 1
}
```

#### GET /api/v1/users/{id}

获取指定用户信息。

**参数**：
- `id`: 用户ID（路径参数）

**响应示例**：
```json
{
  "user": {
    "id": 1,
    "name": "John Doe",
    "email": "john@example.com",
    "createdAt": "2024-01-01T00:00:00.000Z"
  }
}
```

#### POST /api/v1/users

创建新用户。

**请求体**：
```json
{
  "name": "John Doe",
  "email": "john@example.com"
}
```

**响应示例**：
```json
{
  "user": {
    "id": 1,
    "name": "John Doe",
    "email": "john@example.com",
    "createdAt": "2024-01-01T00:00:00.000Z"
  },
  "message": "User created successfully"
}
```

### 文章管理

> 需要认证

#### GET /api/v1/posts

获取所有文章列表。

**请求头**：
```http
Authorization: Bearer valid-token
```

**响应示例**：
```json
{
  "posts": [
    {
      "id": 1,
      "title": "Hello World",
      "content": "This is my first post",
      "authorId": 1,
      "createdAt": "2024-01-01T00:00:00.000Z"
    }
  ],
  "total": 1
}
```

#### POST /api/v1/posts

创建新文章。

**请求头**：
```http
Authorization: Bearer valid-token
Content-Type: application/json
```

**请求体**：
```json
{
  "title": "My First Post",
  "content": "This is the content of my first post."
}
```

**响应示例**：
```json
{
  "post": {
    "id": 1,
    "title": "My First Post",
    "content": "This is the content of my first post.",
    "authorId": 1,
    "createdAt": "2024-01-01T00:00:00.000Z"
  },
  "message": "Post created successfully"
}
```

## 错误处理

### 常见错误码

- 400 Bad Request: 请求参数错误
- 401 Unauthorized: 未认证或认证失败
- 403 Forbidden: 权限不足
- 404 Not Found: 资源不存在
- 500 Internal Server Error: 服务器内部错误

### 错误响应示例

```json
{
  "error": "User not found",
  "stack": "Error: User not found\n    at UserService.getUserById ..."
}
```

## 最佳实践

1. 始终使用 HTTPS 在生产环境中传输数据
2. 合理使用 HTTP 方法：
   - GET: 获取资源
   - POST: 创建资源
   - PUT: 更新资源
   - DELETE: 删除资源
3. 正确处理错误响应
4. 使用合适的 HTTP 状态码
5. 遵循 RESTful 命名约定
```

## 完成标志
- [ ] API测试已完成
- [ ] 使用文档已完成
- [ ] 示例说明已完成
- [ ] 所有测试通过
- [ ] 文档格式正确

## 下一步
完成此步骤后，基础示例项目就完成了！你可以：

1. 继续添加更多功能（数据库、认证、文件上传等）
2. 优化性能和错误处理
3. 添加更多中间件和工具
4. 创建更多示例项目
5. 编写详细的使用文档 
