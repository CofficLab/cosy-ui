# 中间件系统接口设计

## 设计目标

中间件系统是框架的核心组件之一，它提供了请求处理管道的基础设施。设计目标包括：

1. 实现洋葱模型的中间件系统
2. 支持异步中间件处理
3. 提供灵活的中间件组合
4. 实现中间件优先级
5. 支持错误处理中间件

## 核心接口

### 1. 中间件接口

```typescript
interface MiddlewareInterface {
  // 中间件处理
  handle(context: Context, next: Next): Promise<void>;
}

type Next = () => Promise<void>;

// 中间件处理器类型
type MiddlewareHandler = (context: Context, next: Next) => Promise<void>;
```

### 2. 中间件管道接口

```typescript
interface MiddlewarePipeline {
  // 管道操作
  pipe(middleware: MiddlewareHandler): this;
  prepend(middleware: MiddlewareHandler): this;
  append(middleware: MiddlewareHandler): this;
  
  // 管道执行
  process(context: Context): Promise<void>;
  
  // 管道管理
  reset(): void;
  clone(): MiddlewarePipeline;
  
  // 中间件信息
  getMiddleware(): MiddlewareHandler[];
  hasMiddleware(middleware: MiddlewareHandler): boolean;
}
```

### 3. 错误处理中间件

```typescript
interface ErrorMiddlewareInterface {
  // 错误处理
  handle(error: Error, context: Context, next: Next): Promise<void>;
}

type ErrorMiddlewareHandler = (error: Error, context: Context, next: Next) => Promise<void>;
```

### 4. 中间件组接口

```typescript
interface MiddlewareGroup {
  // 组配置
  name: string;
  priority: number;
  
  // 中间件管理
  add(middleware: MiddlewareHandler): this;
  remove(middleware: MiddlewareHandler): boolean;
  clear(): void;
  
  // 组信息
  getMiddleware(): MiddlewareHandler[];
  getPriority(): number;
}
```

## 扩展接口

### 1. 中间件工厂

```typescript
interface MiddlewareFactory {
  // 中间件创建
  create(handler: MiddlewareHandler): MiddlewareInterface;
  createError(handler: ErrorMiddlewareHandler): ErrorMiddlewareInterface;
  
  // 中间件组合
  compose(middleware: MiddlewareHandler[]): MiddlewareHandler;
  parallel(middleware: MiddlewareHandler[]): MiddlewareHandler;
}
```

### 2. 中间件注册器

```typescript
interface MiddlewareRegistry {
  // 注册管理
  register(name: string, middleware: MiddlewareHandler): this;
  unregister(name: string): boolean;
  
  // 中间件解析
  resolve(name: string): MiddlewareHandler | null;
  resolveAll(names: string[]): MiddlewareHandler[];
  
  // 注册信息
  has(name: string): boolean;
  getNames(): string[];
}
```

### 3. 中间件配置

```typescript
interface MiddlewareConfig {
  // 配置选项
  enabled: boolean;
  priority?: number;
  options?: Record<string, any>;
  
  // 条件配置
  except?: string[];
  only?: string[];
  
  // 错误处理
  catchErrors?: boolean;
  errorHandler?: ErrorMiddlewareHandler;
}
```

## 内置中间件接口

### 1. 认证中间件

```typescript
interface AuthMiddleware extends MiddlewareInterface {
  // 认证配置
  setGuard(guard: string): this;
  setRoles(roles: string[]): this;
  setPermissions(permissions: string[]): this;
  
  // 认证检查
  authenticate(context: Context): Promise<boolean>;
  authorize(context: Context): Promise<boolean>;
}
```

### 2. 缓存中间件

```typescript
interface CacheMiddleware extends MiddlewareInterface {
  // 缓存配置
  setTTL(ttl: number): this;
  setKey(key: string | ((context: Context) => string)): this;
  setTags(tags: string[]): this;
  
  // 缓存操作
  get(key: string): Promise<any>;
  set(key: string, value: any, ttl?: number): Promise<void>;
  clear(tags?: string[]): Promise<void>;
}
```

### 3. 验证中间件

```typescript
interface ValidationMiddleware extends MiddlewareInterface {
  // 验证配置
  setRules(rules: ValidationRules): this;
  setCustomMessages(messages: Record<string, string>): this;
  
  // 验证处理
  validate(data: any): Promise<boolean>;
  getErrors(): ValidationError[];
}

interface ValidationRules {
  [field: string]: {
    type?: string;
    required?: boolean;
    rules?: Array<(value: any) => boolean | Promise<boolean>>;
  };
}
```

## 使用示例

### 1. 基本中间件

```typescript
// 日志中间件
const loggerMiddleware: MiddlewareHandler = async (context, next) => {
  const start = Date.now();
  
  try {
    await next();
  } finally {
    const duration = Date.now() - start;
    console.log(`${context.request.method} ${context.request.path} - ${duration}ms`);
  }
};

// 错误处理中间件
const errorHandler: ErrorMiddlewareHandler = async (error, context, next) => {
  context.response.status(500).json({
    error: error.message,
    stack: process.env.NODE_ENV === 'development' ? error.stack : undefined
  });
};
```

### 2. 中间件组合

```typescript
// API 中间件组
const apiMiddleware = pipeline.compose([
  cors(),
  bodyParser(),
  authentication(),
  rateLimit()
]);

// 管理员中间件组
const adminMiddleware = pipeline.compose([
  authentication(),
  authorization(['admin']),
  audit()
]);

// 应用中间件
app.use(loggerMiddleware);
app.use(apiMiddleware);

// 路由中间件
router.group('/admin', {
  middleware: [adminMiddleware]
}, admin => {
  admin.get('/dashboard', DashboardController.index);
});
```

### 3. 条件中间件

```typescript
// 条件认证中间件
const auth = new AuthMiddleware()
  .setGuard('api')
  .setRoles(['user'])
  .except(['/public', '/auth/*']);

// 缓存中间件
const cache = new CacheMiddleware()
  .setTTL(3600)
  .setKey(context => `${context.request.path}:${context.user?.id}`)
  .setTags(['api', 'users']);

// 验证中间件
const validate = new ValidationMiddleware()
  .setRules({
    email: { type: 'email', required: true },
    password: { type: 'string', required: true }
  });
```

## 设计原则

### 1. 洋葱模型

- 请求从外到内处理
- 响应从内到外处理
- 保持执行顺序

### 2. 可组合性

- 支持中间件组合
- 灵活的执行顺序
- 条件执行控制

### 3. 错误处理

- 统一的错误处理
- 错误中间件支持
- 错误恢复机制

### 4. 性能优化

- 中间件缓存
- 条件执行
- 并行处理

## 注意事项

1. **执行顺序**
   - 注意中间件顺序
   - 处理依赖关系
   - 避免循环依赖

2. **错误处理**
   - 捕获所有错误
   - 正确的错误传播
   - 优雅的错误响应

3. **性能考虑**
   - 避免阻塞操作
   - 合理使用异步
   - 优化执行路径

## 下一步

理解了中间件系统接口后，我们将：

1. 学习配置系统接口
2. 了解应用程序接口
3. 掌握错误处理接口

请继续阅读 [02.5-config.md](./02.5-config.md) 了解配置系统接口设计。 