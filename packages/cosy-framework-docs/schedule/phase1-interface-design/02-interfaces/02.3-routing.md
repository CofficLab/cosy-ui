# 路由系统接口设计

## 设计目标

路由系统负责 HTTP 请求的分发和处理，是框架的核心组件之一。设计目标包括：

1. 提供灵活的路由定义方式
2. 支持参数提取和验证
3. 实现路由组和中间件集成
4. 提供声明式的路由装饰器
5. 确保类型安全和性能优化

## 核心接口

### 1. 路由器接口

```typescript
interface RouterInterface {
  // 路由注册
  get(path: string, handler: RouteHandler): RouteInterface;
  post(path: string, handler: RouteHandler): RouteInterface;
  put(path: string, handler: RouteHandler): RouteInterface;
  patch(path: string, handler: RouteHandler): RouteInterface;
  delete(path: string, handler: RouteHandler): RouteInterface;
  options(path: string, handler: RouteHandler): RouteInterface;
  head(path: string, handler: RouteHandler): RouteInterface;
  any(path: string, handler: RouteHandler): RouteInterface;
  
  // 路由组
  group(prefix: string | RouteGroupOptions, callback: (router: RouterInterface) => void): void;
  
  // 中间件
  use(middleware: MiddlewareHandler): this;
  
  // 路由查找
  match(method: string, path: string): RouteMatch | null;
  
  // 路由信息
  getRoutes(): RouteInterface[];
  hasRoute(name: string): boolean;
  getRoute(name: string): RouteInterface | null;
}

interface RouteGroupOptions {
  prefix?: string;
  middleware?: MiddlewareHandler[];
  name?: string;
}

interface RouteMatch {
  route: RouteInterface;
  params: Record<string, string>;
}
```

### 2. 路由接口

```typescript
interface RouteInterface {
  // 路由配置
  name(name: string): this;
  middleware(middleware: MiddlewareHandler | MiddlewareHandler[]): this;
  where(constraints: Record<string, RegExp | string>): this;
  
  // 路由信息
  getPath(): string;
  getMethod(): string;
  getName(): string | undefined;
  getHandler(): RouteHandler;
  getMiddleware(): MiddlewareHandler[];
  
  // 参数处理
  getParams(path: string): Record<string, string> | null;
  hasParam(name: string): boolean;
  getParamNames(): string[];
  
  // 约束检查
  matchesPath(path: string): boolean;
  matchesMethod(method: string): boolean;
}

type RouteHandler = (context: Context) => Promise<any> | any;
```

### 3. 控制器接口

```typescript
interface ControllerInterface {
  // 路由前缀
  prefix?: string;
  
  // 中间件
  middleware?: MiddlewareHandler[];
  
  // 路由映射
  routes?: Record<string, RouteDefinition>;
}

interface RouteDefinition {
  method: string;
  path: string;
  handler: RouteHandler;
  middleware?: MiddlewareHandler[];
}
```

### 4. 路由装饰器接口

```typescript
interface RouteDecorator {
  (path?: string): MethodDecorator;
}

interface ControllerDecorator {
  (prefix?: string): ClassDecorator;
}

interface MiddlewareDecorator {
  (middleware: MiddlewareHandler | MiddlewareHandler[]): MethodDecorator & ClassDecorator;
}

interface RouteConstraintDecorator {
  (constraints: Record<string, RegExp | string>): MethodDecorator;
}
```

## 扩展接口

### 1. 路由参数验证

```typescript
interface RouteParamValidator {
  // 参数验证
  validate(params: Record<string, string>): boolean;
  
  // 错误信息
  getErrors(): ValidationError[];
}

interface ValidationError {
  param: string;
  value: string;
  message: string;
}

interface ValidatorOptions {
  // 验证选项
  required?: boolean;
  pattern?: RegExp;
  transform?: (value: string) => any;
  validate?: (value: any) => boolean | Promise<boolean>;
}
```

### 2. 路由缓存

```typescript
interface RouteCacheInterface {
  // 缓存操作
  get(key: string): RouteMatch | null;
  set(key: string, match: RouteMatch): void;
  has(key: string): boolean;
  clear(): void;
  
  // 缓存键生成
  generateKey(method: string, path: string): string;
}
```

### 3. 路由文档

```typescript
interface RouteDocumentation {
  // 路由信息
  path: string;
  method: string;
  description?: string;
  
  // 参数文档
  params?: ParamDocumentation[];
  query?: QueryDocumentation[];
  body?: BodyDocumentation;
  
  // 响应文档
  responses?: ResponseDocumentation[];
}

interface ParamDocumentation {
  name: string;
  type: string;
  required: boolean;
  description?: string;
}

interface ResponseDocumentation {
  status: number;
  description: string;
  schema?: any;
}
```

## 工厂接口

### 1. 路由工厂

```typescript
interface RouterFactory {
  // 创建路由器
  create(options?: RouterOptions): RouterInterface;
  
  // 创建路由
  createRoute(method: string, path: string, handler: RouteHandler): RouteInterface;
  
  // 创建路由组
  createGroup(options: RouteGroupOptions): RouterInterface;
}

interface RouterOptions {
  // 路由器选项
  caseSensitive?: boolean;
  strict?: boolean;
  prefix?: string;
  middleware?: MiddlewareHandler[];
}
```

### 2. 控制器工厂

```typescript
interface ControllerFactory {
  // 创建控制器
  create(controller: Constructor<any>): ControllerInterface;
  
  // 注册路由
  registerRoutes(router: RouterInterface, controller: ControllerInterface): void;
}
```

## 使用示例

### 1. 基本路由定义

```typescript
@Controller('/users')
class UserController {
  constructor(private userService: UserService) {}
  
  @Get('/')
  async list(context: Context) {
    const users = await this.userService.findAll();
    return { users };
  }
  
  @Post('/')
  @Middleware(validateUser)
  async create(context: Context) {
    const user = await this.userService.create(context.request.body);
    return { user };
  }
  
  @Get('/{id}')
  @Where({ id: /^\d+$/ })
  async show(context: Context) {
    const user = await this.userService.findById(context.params.id);
    if (!user) {
      context.throw(404, 'User not found');
    }
    return { user };
  }
}
```

### 2. 路由组织

```typescript
// API 路由组
router.group('/api', api => {
  // 认证路由组
  api.group('/auth', auth => {
    auth.post('/login', AuthController.login);
    auth.post('/register', AuthController.register);
  });
  
  // 用户路由组
  api.group('/users', users => {
    users.get('/', UserController.list);
    users.post('/', UserController.create);
    users.get('/{id}', UserController.show);
  });
});
```

### 3. 中间件集成

```typescript
@Controller('/admin')
@Middleware([auth, admin])
class AdminController {
  @Get('/dashboard')
  @Middleware(cache('5m'))
  async dashboard(context: Context) {
    const stats = await this.statsService.getDashboard();
    return { stats };
  }
  
  @Post('/settings')
  @Middleware(validate(settingsSchema))
  async updateSettings(context: Context) {
    const settings = await this.settingsService.update(context.request.body);
    return { settings };
  }
}
```

## 设计原则

### 1. 声明式路由

- 使用装饰器定义路由
- 支持控制器类
- 自动参数注入

### 2. 灵活性

- 支持多种注册方式
- 可扩展的路由系统
- 自定义参数处理

### 3. 类型安全

- 完整的类型定义
- 参数类型推导
- 响应类型检查

### 4. 性能优化

- 路由缓存
- 参数预处理
- 避免重复计算

## 注意事项

1. **路由顺序**
   - 具体路由先于通配符
   - 正确处理冲突
   - 合理使用参数约束

2. **安全考虑**
   - 参数验证
   - 路由保护
   - 访问控制

3. **性能优化**
   - 路由缓存
   - 参数预处理
   - 避免过深嵌套

## 下一步

理解了路由系统接口后，我们将：

1. 学习中间件系统接口
2. 了解配置系统接口
3. 掌握应用程序接口

请继续阅读 [02.4-middleware.md](./02.4-middleware.md) 了解中间件系统接口设计。 
