# 步骤 03.4：HTTP 上下文实现

## 目标
实现 HTTP 上下文类，提供请求和响应的统一访问接口。

## 任务清单
- [ ] 实现上下文类基本结构
- [ ] 实现上下文工厂方法
- [ ] 实现原生请求集成
- [ ] 实现测试辅助方法

## 执行步骤

### 1. 创建上下文类

**创建文件**: `src/http/context.ts`

```typescript
import { HttpContextInterface, RequestInterface, ResponseInterface } from '../types'
import { Request } from './request'
import { Response } from './response'

/**
 * HTTP 上下文类
 * 
 * 主要功能：
 * 1. 请求和响应的统一访问
 * 2. 原生请求的集成
 * 3. 测试支持
 * 4. 上下文工厂方法
 */
export class HttpContext implements HttpContextInterface {
  public readonly request: RequestInterface
  public readonly response: ResponseInterface

  /**
   * 构造函数
   * 
   * @param request 请求实例
   * @param response 可选的响应实例
   */
  constructor(request: RequestInterface, response?: ResponseInterface) {
    this.request = request
    this.response = response || new Response()
  }

  /**
   * 从原生 HTTP 请求创建上下文
   * 
   * 原理：
   * 1. 提取请求信息
   * 2. 创建请求和响应实例
   * 3. 构建上下文
   * 
   * @param req Node.js HTTP 请求对象
   * @param res Node.js HTTP 响应对象（可选）
   */
  static fromIncomingMessage(req: any, res?: any): HttpContext {
    const request = new Request({
      method: req.method || 'GET',
      url: req.url || '/',
      headers: req.headers || {},
      body: req.body || {},
      query: req.query || {},
      ip: req.ip || req.connection?.remoteAddress || '',
      userAgent: req.headers?.['user-agent'] || ''
    })

    const response = new Response()

    return new HttpContext(request, response)
  }

  /**
   * 从对象创建上下文（用于测试）
   * 
   * 特点：
   * 1. 简化的创建接口
   * 2. 默认值处理
   * 3. 适合测试场景
   * 
   * @param options 上下文选项
   */
  static create(options: {
    method?: string
    url?: string
    headers?: Record<string, string>
    body?: any
    query?: Record<string, any>
    params?: Record<string, any>
  } = {}): HttpContext {
    const request = new Request({
      method: options.method || 'GET',
      url: options.url || '/',
      headers: options.headers || {},
      body: options.body || {},
      query: options.query || {},
      params: options.params || {}
    })

    const response = new Response()

    return new HttpContext(request, response)
  }

  /**
   * 获取请求方法
   */
  getMethod(): string {
    return this.request.method
  }

  /**
   * 获取请求路径
   */
  getPath(): string {
    return this.request.path
  }

  /**
   * 获取请求输入数据
   */
  input(key?: string, defaultValue?: any): any {
    return this.request.input(key, defaultValue)
  }

  /**
   * 获取响应状态码
   */
  getStatus(): number {
    return this.response.getStatus()
  }

  /**
   * 检查是否已响应
   */
  hasResponded(): boolean {
    return this.response.hasResponded()
  }

  /**
   * 发送 JSON 响应
   */
  json(data: any): HttpContext {
    this.response.json(data)
    return this
  }

  /**
   * 发送 HTML 响应
   */
  html(content: string): HttpContext {
    this.response.html(content)
    return this
  }

  /**
   * 重定向
   */
  redirect(url: string): HttpContext {
    this.response.redirect(url)
    return this
  }
}
```

## 实现说明

### 1. 基本结构
- 实现 `HttpContextInterface` 接口
- 请求和响应的封装
- 便捷的访问方法

### 2. 工厂方法
- `fromIncomingMessage`: 从原生请求创建
- `create`: 从选项对象创建
- 默认值处理

### 3. 原生请求集成
- 提取请求信息
- 处理请求体
- 处理查询参数
- IP 地址处理

### 4. 测试支持
- 简化的创建接口
- 默认值处理
- 链式调用支持

### 5. 便捷方法
- 请求数据访问
- 响应生成
- 状态检查

## 使用示例

```typescript
// 从选项创建上下文
const context = HttpContext.create({
  method: 'POST',
  url: '/api/users',
  body: { name: 'John' },
  headers: {
    'content-type': 'application/json'
  }
})

// 访问请求数据
console.log(context.getMethod())        // 'POST'
console.log(context.getPath())          // '/api/users'
console.log(context.input('name'))      // 'John'

// 生成响应
context.json({
  id: 1,
  name: context.input('name'),
  created_at: new Date()
})

// 检查状态
console.log(context.getStatus())        // 200
console.log(context.hasResponded())     // true

// 从原生请求创建
const nodeContext = HttpContext.fromIncomingMessage(req, res)
nodeContext.json({ status: 'success' })
```

## 完成标志
- [ ] 上下文类实现完整
- [ ] 工厂方法正常工作
- [ ] 原生请求集成正确
- [ ] 测试支持完整
- [ ] TypeScript 类型检查无错误

## 下一步
完成此步骤后，继续执行 `03.5-http-helpers.md`。 
