# 步骤 03.2：HTTP 请求实现

## 目标
实现 HTTP 请求类，提供统一的请求数据访问接口。

## 任务清单
- [ ] 实现请求类基本结构
- [ ] 实现输入数据处理
- [ ] 实现请求头处理
- [ ] 实现 Cookie 处理
- [ ] 实现文件上传处理
- [ ] 实现请求类型检测

## 执行步骤

### 1. 创建请求类

**创建文件**: `src/http/request.ts`

```typescript
import { RequestInterface, FileUpload } from '../types'

/**
 * HTTP 请求类
 * 
 * 主要功能：
 * 1. 统一的请求数据访问接口
 * 2. 请求类型检测
 * 3. 文件上传处理
 * 4. 输入数据规范化
 */
export class Request implements RequestInterface {
  public method: string
  public url: string
  public path: string
  public query: Record<string, any> = {}
  public params: Record<string, any> = {}
  public headers: Record<string, string> = {}
  public body: any = {}
  public cookies: Record<string, string> = {}
  public files: Record<string, FileUpload[]> = {}
  public ip: string = ''
  public userAgent: string = ''

  constructor(options: {
    method: string
    url: string
    headers?: Record<string, string>
    body?: any
    query?: Record<string, any>
    params?: Record<string, any>
    cookies?: Record<string, string>
    files?: Record<string, FileUpload[]>
    ip?: string
    userAgent?: string
  }) {
    this.method = options.method.toUpperCase()
    this.url = options.url
    this.headers = options.headers || {}
    this.body = options.body || {}
    this.query = options.query || {}
    this.params = options.params || {}
    this.cookies = options.cookies || {}
    this.files = options.files || {}
    this.ip = options.ip || ''
    this.userAgent = options.userAgent || this.headers['user-agent'] || ''

    // 解析路径（移除查询字符串）
    const urlObj = new URL(this.url, 'http://localhost')
    this.path = urlObj.pathname
  }

  /**
   * 获取请求数据
   * 
   * 优先级：
   * 1. 请求体数据
   * 2. 查询字符串数据
   * 3. 默认值
   */
  get(key: string): any {
    return this.input(key)
  }

  /**
   * 检查是否存在某个键
   */
  has(key: string): boolean {
    return this.input(key) !== undefined
  }

  /**
   * 获取输入数据（从 body 和 query 中）
   * 
   * @param key 可选的键名
   * @param defaultValue 默认值
   * @returns 如果未提供键名，返回所有输入数据
   */
  input(key?: string, defaultValue?: any): any {
    const allInput = { ...this.query, ...this.body }
    
    if (key === undefined) {
      return allInput
    }
    
    return allInput[key] ?? defaultValue
  }

  /**
   * 获取 Cookie
   */
  cookie(name: string, defaultValue?: string): string {
    return this.cookies[name] ?? defaultValue ?? ''
  }

  /**
   * 获取请求头（不区分大小写）
   */
  header(name: string, defaultValue?: string): string {
    const lowerName = name.toLowerCase()
    for (const [key, value] of Object.entries(this.headers)) {
      if (key.toLowerCase() === lowerName) {
        return value
      }
    }
    return defaultValue ?? ''
  }

  /**
   * 获取上传文件
   * 
   * @returns 单个文件或文件数组
   */
  file(name: string): FileUpload | FileUpload[] | undefined {
    return this.files[name]
  }

  /**
   * 判断请求是否为 AJAX
   */
  isAjax(): boolean {
    return this.header('x-requested-with') === 'XMLHttpRequest'
  }

  /**
   * 判断是否为 JSON 请求
   */
  isJson(): boolean {
    const contentType = this.header('content-type').toLowerCase()
    return contentType.includes('application/json')
  }

  /**
   * 判断是否为表单请求
   */
  isForm(): boolean {
    const contentType = this.header('content-type').toLowerCase()
    return contentType.includes('application/x-www-form-urlencoded') ||
           contentType.includes('multipart/form-data')
  }

  /**
   * 获取完整 URL
   */
  fullUrl(): string {
    return this.url
  }

  /**
   * 获取查询字符串
   */
  queryString(): string {
    const urlObj = new URL(this.url, 'http://localhost')
    return urlObj.search
  }
}
```

## 实现说明

### 1. 基本结构
- 实现 `RequestInterface` 接口
- 提供构造函数配置选项
- 规范化请求数据

### 2. 输入数据处理
- 统一的数据访问接口
- 支持默认值
- 合并请求体和查询参数

### 3. 请求头处理
- 不区分大小写的头部访问
- 支持默认值
- 规范化头部名称

### 4. Cookie 处理
- 简单的 Cookie 访问接口
- 支持默认值
- 类型安全的返回值

### 5. 文件上传
- 支持单文件和多文件上传
- 提供文件元数据访问
- 类型安全的文件处理

### 6. 请求类型检测
- AJAX 请求检测
- JSON 请求检测
- 表单请求检测

### 7. URL 处理
- 路径解析
- 查询字符串处理
- 完整 URL 访问

## 使用示例

```typescript
// 创建请求实例
const request = new Request({
  method: 'POST',
  url: '/api/users?filter=active',
  headers: {
    'content-type': 'application/json',
    'x-api-key': 'secret'
  },
  body: {
    name: 'John Doe',
    email: 'john@example.com'
  }
})

// 访问请求数据
console.log(request.method)           // 'POST'
console.log(request.path)            // '/api/users'
console.log(request.input('name'))   // 'John Doe'
console.log(request.get('filter'))   // 'active'
console.log(request.isJson())        // true
```

## 完成标志
- [ ] 请求类实现完整
- [ ] 所有方法正常工作
- [ ] 输入处理正确
- [ ] 文件上传支持完整
- [ ] TypeScript 类型检查无错误

## 下一步
完成此步骤后，继续执行 `03.3-http-response.md`。 
