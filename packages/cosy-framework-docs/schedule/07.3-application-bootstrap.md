# 步骤 007.3：应用程序启动器

## 目标
实现应用程序启动器，提供便捷的应用程序启动和配置机制。

## 任务清单
- [ ] 实现启动器类
- [ ] 实现配置文件加载
- [ ] 实现服务提供者注册
- [ ] 实现生命周期钩子

## 执行步骤

### 1. 创建启动器类

**创建文件**: `src/core/bootstrap.ts`

```typescript
import { Application } from './application'
import { BootstrapOptions, ApplicationConfig } from '../types'
import { Environment, JsonFileSource } from '../config'
import { existsSync } from 'fs'

export class Bootstrap {
  private app: Application
  private options: BootstrapOptions

  constructor(options: BootstrapOptions = {}) {
    this.options = options
    this.app = new Application(options.config)
  }

  /**
   * 启动应用程序
   */
  async start(): Promise<Application> {
    // 设置生命周期钩子
    if (this.options.hooks) {
      this.app.setHooks(this.options.hooks)
    }

    // 加载配置文件
    await this.loadConfigFiles()

    // 注册服务提供者
    this.registerProviders()

    // 启动应用
    await this.app.boot()
    
    const port = this.app.config('app.port')
    await this.app.start(port)

    return this.app
  }

  /**
   * 加载配置文件
   */
  private async loadConfigFiles(): Promise<void> {
    const configPath = this.options.configPath || './config'
    
    // 尝试加载通用配置
    const appConfigPath = `${configPath}/app.json`
    if (existsSync(appConfigPath)) {
      const configSource = new JsonFileSource(appConfigPath)
      await this.app.getConfig().load(configSource)
    }

    // 尝试加载环境特定配置
    const envConfigPath = `${configPath}/${Environment.getCurrent()}.json`
    if (existsSync(envConfigPath)) {
      const envConfigSource = new JsonFileSource(envConfigPath)
      await this.app.getConfig().load(envConfigSource)
    }
  }

  /**
   * 注册服务提供者
   */
  private registerProviders(): void {
    if (this.options.providers) {
      for (const ProviderClass of this.options.providers) {
        const provider = new ProviderClass()
        this.app.register(provider)
      }
    }
  }

  /**
   * 创建启动器
   */
  static create(options: BootstrapOptions = {}): Bootstrap {
    return new Bootstrap(options)
  }

  /**
   * 快速启动
   */
  static async run(options: BootstrapOptions = {}): Promise<Application> {
    const bootstrap = new Bootstrap(options)
    return bootstrap.start()
  }
}
```

### 2. 配置文件结构

应用程序配置文件应遵循以下结构：

**app.json**:
```json
{
  "app": {
    "name": "Cosy Application",
    "debug": false,
    "port": 3000,
    "host": "0.0.0.0"
  },
  "cors": {
    "origin": "*",
    "credentials": true
  }
}
```

**development.json**:
```json
{
  "app": {
    "debug": true
  }
}
```

**production.json**:
```json
{
  "app": {
    "debug": false
  },
  "cors": {
    "origin": "https://api.example.com"
  }
}
```

### 3. 使用示例

```typescript
import { Bootstrap } from '@coffic/cosy-framework'

// 使用默认配置启动
const app = await Bootstrap.create().start()

// 使用自定义配置启动
const app = await Bootstrap.create({
  configPath: './config',
  config: {
    name: 'My App',
    debug: true
  },
  hooks: {
    beforeStart: () => console.log('Starting...'),
    afterStart: () => console.log('Started!')
  }
}).start()

// 快速启动
const app = await Bootstrap.run({
  config: {
    port: 3000
  }
})
```

## 完成标志
- [ ] 启动器类功能完整
- [ ] 配置文件加载正常
- [ ] 服务提供者注册正常
- [ ] 生命周期钩子正常工作
- [ ] TypeScript 类型检查无错误

## 下一步
完成此步骤后，继续执行 `07.4-application-decorators.md`。 
