# 步骤 006.5：日志系统

## 目标
实现一个灵活、可扩展的日志系统，支持多种日志驱动和格式化选项。这个系统将作为框架的基础服务之一，为其他核心功能提供日志支持。

## 依赖
首先需要安装以下依赖：

```bash
pnpm install winston winston-daily-rotate-file
```

## 任务清单
- [ ] 实现日志接口
- [ ] 实现日志管理器
- [ ] 实现多种日志驱动
- [ ] 实现日志格式化器
- [ ] 实现上下文支持
- [ ] 集成到应用程序核心

## 执行步骤

### 1. 定义日志接口

**创建文件**: `src/types/logging.ts`

```typescript
export interface LogContext {
  [key: string]: any
}

export interface LogEntry {
  level: string
  message: string
  context?: LogContext
  timestamp: Date
  channel?: string
}

export interface LogFormatter {
  format(entry: LogEntry): string
}

export interface LogDriver {
  log(entry: LogEntry): Promise<void>
  shutdown(): Promise<void>
}

export interface Logger {
  emergency(message: string, context?: LogContext): Promise<void>
  alert(message: string, context?: LogContext): Promise<void>
  critical(message: string, context?: LogContext): Promise<void>
  error(message: string, context?: LogContext): Promise<void>
  warning(message: string, context?: LogContext): Promise<void>
  notice(message: string, context?: LogContext): Promise<void>
  info(message: string, context?: LogContext): Promise<void>
  debug(message: string, context?: LogContext): Promise<void>
  log(level: string, message: string, context?: LogContext): Promise<void>
  withContext(context: LogContext): Logger
  channel(name: string): Logger
}

export interface LoggerFactory {
  createLogger(channel?: string): Logger
  getDefaultChannel(): string
  setDefaultChannel(channel: string): void
  getChannels(): string[]
}
```

### 2. 实现日志驱动

**创建文件**: `src/logging/drivers/file-driver.ts`

```typescript
import { createWriteStream, WriteStream } from 'fs'
import { LogDriver, LogEntry, LogFormatter } from '../../types/logging'

export class FileDriver implements LogDriver {
  private stream: WriteStream
  private formatter: LogFormatter

  constructor(path: string, formatter: LogFormatter) {
    this.stream = createWriteStream(path, { flags: 'a' })
    this.formatter = formatter
  }

  async log(entry: LogEntry): Promise<void> {
    const formatted = this.formatter.format(entry)
    this.stream.write(formatted + '\n')
  }

  async shutdown(): Promise<void> {
    return new Promise((resolve, reject) => {
      this.stream.end(() => resolve())
    })
  }
}
```

**创建文件**: `src/logging/drivers/console-driver.ts`

```typescript
import { LogDriver, LogEntry, LogFormatter } from '../../types/logging'

export class ConsoleDriver implements LogDriver {
  private formatter: LogFormatter

  constructor(formatter: LogFormatter) {
    this.formatter = formatter
  }

  async log(entry: LogEntry): Promise<void> {
    const formatted = this.formatter.format(entry)
    console.log(formatted)
  }

  async shutdown(): Promise<void> {
    // 控制台驱动不需要特殊的关闭操作
  }
}
```

### 3. 实现日志格式化器

**创建文件**: `src/logging/formatters/line-formatter.ts`

```typescript
import { LogFormatter, LogEntry } from '../../types/logging'

export class LineFormatter implements LogFormatter {
  format(entry: LogEntry): string {
    const timestamp = entry.timestamp.toISOString()
    const channel = entry.channel ? `[${entry.channel}]` : ''
    const context = entry.context ? JSON.stringify(entry.context) : ''
    
    return `[${timestamp}] ${channel} ${entry.level.toUpperCase()}: ${entry.message} ${context}`.trim()
  }
}
```

**创建文件**: `src/logging/formatters/json-formatter.ts`

```typescript
import { LogFormatter, LogEntry } from '../../types/logging'

export class JsonFormatter implements LogFormatter {
  format(entry: LogEntry): string {
    return JSON.stringify({
      timestamp: entry.timestamp.toISOString(),
      level: entry.level,
      message: entry.message,
      channel: entry.channel,
      context: entry.context
    })
  }
}
```

### 4. 实现日志管理器

**创建文件**: `src/logging/logger.ts`

```typescript
import { 
  Logger, 
  LogContext, 
  LogEntry,
  LogDriver 
} from '../types/logging'

export class BaseLogger implements Logger {
  protected context: LogContext = {}
  protected channel?: string

  constructor(
    protected driver: LogDriver,
    channel?: string
  ) {
    this.channel = channel
  }

  async emergency(message: string, context?: LogContext): Promise<void> {
    return this.log('emergency', message, context)
  }

  async alert(message: string, context?: LogContext): Promise<void> {
    return this.log('alert', message, context)
  }

  async critical(message: string, context?: LogContext): Promise<void> {
    return this.log('critical', message, context)
  }

  async error(message: string, context?: LogContext): Promise<void> {
    return this.log('error', message, context)
  }

  async warning(message: string, context?: LogContext): Promise<void> {
    return this.log('warning', message, context)
  }

  async notice(message: string, context?: LogContext): Promise<void> {
    return this.log('notice', message, context)
  }

  async info(message: string, context?: LogContext): Promise<void> {
    return this.log('info', message, context)
  }

  async debug(message: string, context?: LogContext): Promise<void> {
    return this.log('debug', message, context)
  }

  async log(level: string, message: string, context?: LogContext): Promise<void> {
    const entry: LogEntry = {
      level,
      message,
      context: { ...this.context, ...context },
      timestamp: new Date(),
      channel: this.channel
    }

    await this.driver.log(entry)
  }

  withContext(context: LogContext): Logger {
    const logger = new BaseLogger(this.driver, this.channel)
    logger.context = { ...this.context, ...context }
    return logger
  }

  channel(name: string): Logger {
    return new BaseLogger(this.driver, name)
  }
}
```

**创建文件**: `src/logging/logger-factory.ts`

```typescript
import { 
  LoggerFactory, 
  Logger,
  LogDriver,
  LogFormatter 
} from '../types/logging'
import { BaseLogger } from './logger'
import { FileDriver } from './drivers/file-driver'
import { ConsoleDriver } from './drivers/console-driver'
import { LineFormatter } from './formatters/line-formatter'
import { JsonFormatter } from './formatters/json-formatter'
import { Environment } from '../config'

export class LogManager implements LoggerFactory {
  private channels: Map<string, Logger> = new Map()
  private defaultChannel = 'app'

  constructor(private config: any) {
    this.setupDefaultChannels()
  }

  private setupDefaultChannels(): void {
    // 设置默认的应用日志
    this.channels.set('app', this.createFileLogger('logs/app.log'))
    
    // 设置错误日志
    this.channels.set('error', this.createFileLogger('logs/error.log'))
    
    // 开发环境添加控制台日志
    if (Environment.isDevelopment()) {
      this.channels.set('console', this.createConsoleLogger())
    }
  }

  private createFileLogger(path: string): Logger {
    const formatter = new LineFormatter()
    const driver = new FileDriver(path, formatter)
    return new BaseLogger(driver)
  }

  private createConsoleLogger(): Logger {
    const formatter = new LineFormatter()
    const driver = new ConsoleDriver(formatter)
    return new BaseLogger(driver)
  }

  createLogger(channel?: string): Logger {
    channel = channel || this.defaultChannel
    
    if (!this.channels.has(channel)) {
      throw new Error(`Log channel [${channel}] is not defined`)
    }
    
    return this.channels.get(channel)!
  }

  getDefaultChannel(): string {
    return this.defaultChannel
  }

  setDefaultChannel(channel: string): void {
    if (!this.channels.has(channel)) {
      throw new Error(`Cannot set default channel to [${channel}] as it does not exist`)
    }
    this.defaultChannel = channel
  }

  getChannels(): string[] {
    return Array.from(this.channels.keys())
  }
}
```

### 5. 集成到应用程序

**更新文件**: `src/core/application.ts`

```typescript
import { LoggerFactory, Logger } from '../types/logging'
import { LogManager } from '../logging/logger-factory'

export class Application {
  private logger?: Logger
  private logManager?: LoggerFactory

  // ... 其他代码 ...

  protected registerCoreServices(): void {
    // ... 其他服务注册 ...
    
    // 注册日志管理器
    this.logManager = new LogManager(this.config)
    this.container.instance('log.manager', this.logManager)
    
    // 注册默认日志实例
    this.logger = this.logManager.createLogger()
    this.container.instance('log', this.logger)
  }

  /**
   * 获取日志实例
   */
  log(channel?: string): Logger {
    if (!this.logManager) {
      throw new Error('Logger is not initialized')
    }
    return channel ? this.logManager.createLogger(channel) : this.logger!
  }
}
```

### 6. 使用示例

```typescript
import { Application } from '@coffic/cosy-framework'

const app = new Application()

// 使用默认日志通道
app.log().info('Application starting...')

// 使用特定通道
app.log('error').error('Something went wrong', { 
  error: new Error('Database connection failed') 
})

// 使用上下文
const logger = app.log().withContext({ 
  requestId: '123', 
  userId: '456' 
})
logger.info('User logged in')

// 使用不同通道
const errorLogger = app.log('error')
errorLogger.error('Critical error occurred')
```

## 配置示例

**文件**: `config/logging.json`

```json
{
  "logging": {
    "default": "app",
    "channels": {
      "app": {
        "driver": "file",
        "path": "logs/app.log",
        "level": "info",
        "formatter": "line"
      },
      "error": {
        "driver": "file",
        "path": "logs/error.log",
        "level": "error",
        "formatter": "json"
      },
      "console": {
        "driver": "console",
        "level": "debug",
        "formatter": "line"
      }
    }
  }
}
```

## 完成标志
- [ ] 日志接口定义完整
- [ ] 文件日志驱动实现完成
- [ ] 控制台日志驱动实现完成
- [ ] 日志格式化器实现完成
- [ ] 日志管理器实现完成
- [ ] 应用程序集成完成
- [ ] 配置系统支持完成
- [ ] 所有测试通过
- [ ] TypeScript 类型检查无错误

## 注意事项

1. **日志级别**：
   - emergency: 系统不可用
   - alert: 必须立即采取行动
   - critical: 危险情况
   - error: 错误事件
   - warning: 警告但不是错误
   - notice: 普通但重要
   - info: 感兴趣的事件
   - debug: 详细的调试信息

2. **性能考虑**：
   - 使用异步写入
   - 支持日志轮转
   - 避免阻塞操作

3. **安全考虑**：
   - 敏感信息不应记录
   - 日志文件权限控制
   - 日志轮转防止磁盘占满

4. **最佳实践**：
   - 使用结构化日志
   - 合理使用日志级别
   - 添加有意义的上下文
   - 定期清理旧日志

## 下一步
完成此步骤后，继续实现应用程序核心（步骤 007）。 