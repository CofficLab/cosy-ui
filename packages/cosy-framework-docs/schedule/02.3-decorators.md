# 步骤 02.3：装饰器实现

## 目标
实现服务容器相关的装饰器，提供声明式的依赖注入和服务注册。

## 任务清单
- [ ] 实现注入装饰器
- [ ] 实现服务装饰器
- [ ] 实现生命周期装饰器
- [ ] 实现元数据管理

## 执行步骤

### 1. 创建装饰器

**创建文件**: `src/container/decorators.ts`

```typescript
import 'reflect-metadata'
import { Token, Constructor, InjectMetadata, ServiceMetadata } from '../types'

// 元数据键
const INJECT_METADATA_KEY = Symbol('inject')
const SERVICE_METADATA_KEY = Symbol('service')
const PARAMS_METADATA_KEY = Symbol('params')

/**
 * 服务装饰器
 */
export function Injectable(options: Partial<ServiceMetadata> = {}) {
  return function <T extends Constructor>(target: T) {
    const metadata: ServiceMetadata = {
      token: options.token || target,
      singleton: options.singleton ?? true,
      dependencies: options.dependencies || []
    }
    
    Reflect.defineMetadata(SERVICE_METADATA_KEY, metadata, target)
    return target
  }
}

/**
 * 依赖注入装饰器
 */
export function Inject(token?: Token, optional = false) {
  return function (target: Object, propertyKey: string | symbol | undefined, parameterIndex?: number) {
    const metadata: InjectMetadata = {
      token: token || Reflect.getMetadata('design:type', target, propertyKey!),
      optional
    }

    if (parameterIndex !== undefined) {
      // 构造函数参数装饰器
      const params = Reflect.getMetadata(PARAMS_METADATA_KEY, target) || []
      params[parameterIndex] = metadata
      Reflect.defineMetadata(PARAMS_METADATA_KEY, params, target)
    } else {
      // 属性装饰器
      Reflect.defineMetadata(INJECT_METADATA_KEY, metadata, target, propertyKey!)
    }
  }
}

/**
 * 获取服务元数据
 */
export function getServiceMetadata(target: Constructor): ServiceMetadata | undefined {
  return Reflect.getMetadata(SERVICE_METADATA_KEY, target)
}

/**
 * 获取注入元数据
 */
export function getInjectMetadata(target: Object, propertyKey: string | symbol): InjectMetadata | undefined {
  return Reflect.getMetadata(INJECT_METADATA_KEY, target, propertyKey)
}

/**
 * 获取参数注入元数据
 */
export function getParamMetadata(target: Constructor): InjectMetadata[] {
  return Reflect.getMetadata(PARAMS_METADATA_KEY, target) || []
}

/**
 * 生命周期装饰器 - 启动
 */
export function OnBoot() {
  return function (target: any, propertyKey: string, descriptor: PropertyDescriptor) {
    Reflect.defineMetadata('lifecycle:boot', true, target, propertyKey)
    return descriptor
  }
}

/**
 * 生命周期装饰器 - 关闭
 */
export function OnShutdown() {
  return function (target: any, propertyKey: string, descriptor: PropertyDescriptor) {
    Reflect.defineMetadata('lifecycle:shutdown', true, target, propertyKey)
    return descriptor
  }
}
```

### 2. 使用示例

```typescript
import { Injectable, Inject, OnBoot, OnShutdown } from './decorators'

// 定义服务
@Injectable()
class DatabaseService {
  connect() {
    return 'Connected to database'
  }
}

@Injectable()
class UserService {
  constructor(
    @Inject() private db: DatabaseService,
    @Inject('CONFIG', true) private config?: any
  ) {}

  @OnBoot()
  async initialize() {
    console.log('Initializing user service...')
  }

  @OnShutdown()
  async cleanup() {
    console.log('Cleaning up user service...')
  }
}

// 属性注入示例
@Injectable()
class AuthService {
  @Inject()
  private userService!: UserService

  @Inject('CONFIG')
  private config!: any
}
```

## 装饰器说明

### @Injectable
- 将类标记为可注入的服务
- 支持配置服务标识符和生命周期
- 自动收集依赖信息

### @Inject
- 支持构造函数参数注入
- 支持属性注入
- 支持可选依赖
- 支持自定义标识符

### 生命周期装饰器
- @OnBoot: 启动时执行
- @OnShutdown: 关闭时执行
- 支持异步操作

## 元数据管理
- 使用 reflect-metadata 存储元数据
- 支持依赖关系的自动收集
- 支持运行时类型信息

## 完成标志
- [ ] 所有装饰器功能完整
- [ ] 元数据处理正确
- [ ] 生命周期钩子正常工作
- [ ] TypeScript 类型检查无错误

## 下一步
完成此步骤后，继续执行 `02.4-service-provider.md`。 
