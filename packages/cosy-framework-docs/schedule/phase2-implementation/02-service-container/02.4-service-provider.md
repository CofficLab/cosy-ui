# 步骤 02.4：服务提供者实现

## 目标
实现服务提供者基类和相关功能，提供统一的服务注册和生命周期管理机制。服务提供者用于将相关的服务组织在一起，使其更易于管理和维护。

## 任务清单
- [ ] 实现服务提供者基类
- [ ] 实现服务注册机制
- [ ] 实现生命周期钩子
- [ ] 实现自动注册功能

## 执行步骤

### 1. 创建服务提供者基类

**创建文件**: `src/container/service-provider.ts`

```typescript
import { ServiceProvider, Container } from '../types'

/**
 * 服务提供者基类
 * 
 * 服务提供者用于统一管理一组相关服务的注册和生命周期。
 * 它提供了一个标准化的方式来:
 * - 注册多个相关的服务
 * - 管理服务的启动和关闭
 * - 处理服务之间的依赖关系
 */
export abstract class BaseServiceProvider implements ServiceProvider {
    /**
     * 注册服务到容器
     * 
     * 在这个方法中实现服务的注册逻辑。可以注册多个相关的服务，
     * 设置它们的生命周期（单例/瞬态），并处理它们之间的依赖关系。
     */
    abstract register(container: Container): void

    /**
     * 启动服务（可选）
     * 
     * 当容器启动时，此方法会被调用。
     * 可以在这里执行服务的初始化逻辑，例如：
     * - 建立数据库连接
     * - 加载配置文件
     * - 启动后台任务
     * - 初始化外部服务连接
     */
    boot?(container: Container): void
}
```

### 2. 服务提供者使用示例

#### 2.1 基础服务提供者

```typescript
import { BaseServiceProvider } from './service-provider'
import { DatabaseService, UserService, AuthService } from '../services'

export class AppServiceProvider extends BaseServiceProvider {
    register(container: Container): void {
        // 注册核心服务
        container.singleton('db', DatabaseService)
        container.singleton('users', UserService)
        container.singleton('auth', AuthService)
    }

    boot(container: Container): void {
        // 启动时的初始化逻辑
        const db = container.resolve<DatabaseService>('db')
        db.connect()
    }
}
```

#### 2.2 数据库服务提供者

```typescript
export class DatabaseServiceProvider extends BaseServiceProvider {
    register(container: Container): void {
        // 注册数据库相关服务
        container.singleton('db.connection', DbConnection)
        container.singleton('db.migrations', MigrationService)
        container.singleton('db.seeder', SeederService)
    }

    boot(container: Container): void {
        // 数据库初始化
        const connection = container.resolve<DbConnection>('db.connection')
        connection.connect()
        
        // 运行迁移
        const migrations = container.resolve<MigrationService>('db.migrations')
        migrations.runPending()
    }
}
```

## 服务提供者最佳实践

### 1. 组织原则

1. **单一职责**
   - 每个服务提供者应该只负责一个功能模块
   - 相关的服务应该组织在同一个提供者中
   - 避免在一个提供者中混合不相关的服务

2. **命名规范**
   - 使用描述性的名称，如 `DatabaseServiceProvider`
   - 名称应该反映提供者的功能
   - 始终以 `Provider` 或 `ServiceProvider` 结尾

3. **目录结构**
   ```
   src/
   ├── providers/
   │   ├── AppServiceProvider.ts
   │   ├── DatabaseServiceProvider.ts
   │   ├── CacheServiceProvider.ts
   │   └── QueueServiceProvider.ts
   ```

### 2. 生命周期管理

1. **注册阶段 (register)**
   - 只进行服务绑定
   - 不要在这里执行初始化逻辑
   - 可以设置服务的配置

2. **启动阶段 (boot)**
   - 执行服务初始化
   - 建立外部连接
   - 启动后台任务

### 3. 依赖处理

1. **显式依赖**
   ```typescript
   class UserServiceProvider extends BaseServiceProvider {
       register(container: Container): void {
           // 先注册依赖
           container.singleton('db', Database)
           // 再注册依赖服务
           container.singleton('users', UserService)
       }
   }
   ```

2. **避免循环依赖**
   - 明确服务之间的依赖关系
   - 使用接口进行解耦
   - 考虑使用事件系统代替直接依赖

### 4. 错误处理

1. **注册错误**
   ```typescript
   register(container: Container): void {
       try {
           container.singleton('service', Service)
       } catch (error) {
           // 处理注册错误
           console.error('Service registration failed:', error)
           throw error
       }
   }
   ```

2. **启动错误**
   ```typescript
   boot(container: Container): void {
       try {
           const service = container.resolve('service')
           await service.initialize()
       } catch (error) {
           // 处理启动错误
           console.error('Service boot failed:', error)
           throw error
       }
   }
   ```

## 完成标志
- [ ] 服务提供者基类实现完成
- [ ] 示例服务提供者工作正常
- [ ] 生命周期钩子正确执行
- [ ] 错误处理机制完善
- [ ] TypeScript 类型检查无错误

## 下一步
完成此步骤后，继续执行 `02.5-testing.md`。 
