# 步骤 08.2：应用核心实现

## 目标
实现应用程序的核心功能，包括应用配置、服务器启动和错误处理。

## 任务清单
- [ ] 实现应用入口文件
- [ ] 实现服务器启动文件
- [ ] 配置应用实例

## 执行步骤

### 1. 创建应用入口文件

**创建文件**: `packages/cosy-framework-example/src/app.ts`

```typescript
import { 
    Application, 
    gracefulShutdown, 
    setupErrorHandling,
    cors,
    logger,
    errorHandler,
    type HttpContextInterface
} from '@coffic/cosy-framework'
import { UserController } from './controllers/user-controller'
import { PostController } from './controllers/post-controller'
import { AuthMiddleware } from './middleware/auth-middleware'
import { UserService } from './services/user-service'
import { PostService } from './services/post-service'

// 创建应用实例
console.log("🚀🚀 创建应用实例")
const app = Application.create({
    name: 'Basic API Example',
    debug: process.env.NODE_ENV !== 'production',
    port: parseInt(process.env.PORT || '3000')
})

// 注册服务
app.bind('UserService', UserService)
app.bind('PostService', PostService)

// 注册中间件
app.middleware('auth', AuthMiddleware)

// 全局中间件
app.use(cors({
    origin: process.env.CORS_ORIGIN || '*',
    credentials: true
}))

app.use(logger({
    skip: (context: HttpContextInterface) => context.request.path === '/health'
}))

app.use(errorHandler({
    showStack: app.config('app.debug')
}))

// 健康检查路由
app.get('/health', () => ({
    status: 'ok',
    timestamp: new Date().toISOString(),
    uptime: process.uptime()
}))

// API 路由
app.group('/api/v1', (api) => {
    // 用户路由
    api.group('/users', (users) => {
        users.get('/', (context) => {
            const userService = app.resolve<UserService>('UserService')
            return userService.getUsers()
        })

        users.get('/{id}', (context) => {
            const userService = app.resolve<UserService>('UserService')
            const id = parseInt(context.request.params.id)
            return userService.getUserById(id)
        })

        users.post('/', (context) => {
            const userService = app.resolve<UserService>('UserService')
            const userData = context.request.body
            return userService.createUser(userData)
        })

        users.put('/{id}', (context) => {
            const userService = app.resolve<UserService>('UserService')
            const id = parseInt(context.request.params.id)
            const userData = context.request.body
            return userService.updateUser(id, userData)
        })

        users.delete('/{id}', (context) => {
            const userService = app.resolve<UserService>('UserService')
            const id = parseInt(context.request.params.id)
            return userService.deleteUser(id)
        })
    })

    // 需要认证的路由
    api.group({ prefix: '/posts', middleware: AuthMiddleware }, (posts) => {
        posts.get('/', (context) => {
            const postService = app.resolve<PostService>('PostService')
            return postService.getPosts()
        })

        posts.post('/', (context) => {
            const postService = app.resolve<PostService>('PostService')
            const postData = context.request.body
            const userId = (context as any).user?.id
            return postService.createPost(postData, userId)
        })
    })
})

// 错误处理
setupErrorHandling(app)

// 优雅关闭
gracefulShutdown(app)

// 导出应用实例供 server.ts 使用
export { app }
```

### 2. 创建服务器启动文件

**创建文件**: `packages/cosy-framework-example/src/server.ts`

```typescript
/**
 * @file server.ts
 * @description 服务器启动入口文件，负责引导应用程序的启动过程
 * 
 * 该文件主要职责：
 * 1. 启动应用程序
 * 2. 处理启动过程中的错误
 */

import { app } from './app'

/**
 * 启动服务器的主函数
 * @description 负责启动应用程序并处理启动过程中的错误
 * @returns {Promise<Application>} 返回启动成功的应用实例，主要用于测试目的
 * @throws {Error} 当服务器启动失败时抛出错误
 */
async function startServer() {
    try {
        console.log('🔄 正在启动服务器...')
        
        await app.boot()
        await app.start()
        
        console.log('✅ 服务器启动成功!')
        console.log('🏥 健康检查: http://localhost:3000/health')
        
        return app
    } catch (error) {
        console.error('❌ 服务器启动失败:', error)
        process.exit(1)
    }
}

// 如果直接运行此文件，启动服务器
if (require.main === module) {
    startServer()
}

export { startServer }
```

### 3. 创建配置文件

#### 3.1 基础配置

**创建文件**: `packages/cosy-framework-example/config/app.json`

```json
{
  "app": {
    "name": "Basic API Example",
    "version": "1.0.0",
    "debug": false,
    "port": 3000,
    "host": "0.0.0.0"
  },
  "cors": {
    "origin": "*",
    "credentials": true,
    "methods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
    "allowedHeaders": ["Content-Type", "Authorization"]
  },
  "logging": {
    "level": "info",
    "format": "combined"
  }
}
```

#### 3.2 开发环境配置

**创建文件**: `packages/cosy-framework-example/config/development.json`

```json
{
  "app": {
    "debug": true,
    "port": 3000
  },
  "logging": {
    "level": "debug"
  }
}
```

#### 3.3 生产环境配置

**创建文件**: `packages/cosy-framework-example/config/production.json`

```json
{
  "app": {
    "debug": false,
    "port": 8080
  },
  "cors": {
    "origin": ["https://yourdomain.com"],
    "credentials": true
  },
  "logging": {
    "level": "warn"
  }
}
```

### 4. 创建启动脚本

#### 4.1 生产环境启动脚本

**创建文件**: `packages/cosy-framework-example/scripts/start.sh`

```bash
#!/bin/bash

# Basic API Example 启动脚本

echo "🚀 启动 Cosy Framework Basic API Example"

# 检查 Node.js 版本
NODE_VERSION=$(node -v)
echo "Node.js 版本: $NODE_VERSION"

# 设置环境变量
export NODE_ENV=${NODE_ENV:-development}
echo "环境: $NODE_ENV"

# 构建项目
echo "📦 构建项目..."
npm run build

# 启动应用
echo "🌟 启动应用..."
npm start
```

#### 4.2 开发环境启动脚本

**创建文件**: `packages/cosy-framework-example/scripts/dev.sh`

```bash
#!/bin/bash

# 开发模式启动脚本

echo "🔧 启动开发模式"

# 设置开发环境
export NODE_ENV=development
export APP_DEBUG=true

# 启动开发服务器
npm run dev
```

使脚本可执行：
```bash
chmod +x packages/cosy-framework-example/scripts/*.sh
```

## 完成标志
- [ ] 应用入口文件已实现
- [ ] 服务器启动文件已实现
- [ ] 配置文件已创建
- [ ] 启动脚本已创建
- [ ] 所有文件可以正常运行

## 下一步
完成此步骤后，继续执行 [08.3-api-implementation.md](./08.3-api-implementation.md)。 
