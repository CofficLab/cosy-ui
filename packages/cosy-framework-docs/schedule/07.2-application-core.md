# 步骤 007.2：应用程序核心实现

## 目标
实现应用程序的核心功能，包括生命周期管理、配置管理、服务容器集成等。

## 依赖
首先需要安装以下依赖：

```bash
npm install fastify @fastify/cors
```

## 任务清单
- [ ] 实现应用程序类
- [ ] 实现生命周期管理
- [ ] 实现配置管理
- [ ] 实现服务容器集成
- [ ] 实现中间件系统
- [ ] 实现路由系统

## 执行步骤

### 1. HTTP 服务器实现说明

应用程序核心使用 Fastify 作为 HTTP 服务器实现，主要特点：

1. **高性能**：Fastify 是最快的 web 框架之一
2. **可扩展**：支持插件系统，易于扩展功能
3. **类型安全**：完整的 TypeScript 支持
4. **现代化**：支持 async/await，优秀的请求处理
5. **CORS 支持**：通过 @fastify/cors 插件处理跨域请求

主要实现细节：
- 使用 Fastify 的通配符路由 (`*`) 捕获所有请求
- 将请求委托给框架的请求处理管道
- 支持优雅关闭
- 完整的错误处理
- 环境感知的日志和错误报告

### 2. 创建应用程序类

**创建文件**: `src/core/application.ts`

[此处是 Application 类的完整实现，已经移动到单独的文件中]

### 3. 更新核心模块导出

**更新文件**: `src/core/index.ts`

```typescript
import { Application as BaseApplication } from './application'

// 导出应用程序核心
export { BaseApplication as Application }

// 导出其他核心组件
export { Bootstrap } from './bootstrap'
export { 
    App, 
    AutoRegister, 
    OnStart, 
    OnStop,
    createApp,
    getAppMetadata,
    shouldAutoRegister
} from './decorators'

export {
    createWebApp,
    createApiApp,
    gracefulShutdown,
    setupErrorHandling
} from './helpers'

// 导出类型
export type {
    ApplicationInterface,
    ApplicationConfig,
    ApplicationLifecycleHooks,
    BootstrapOptions
} from '../types'

// 导出默认应用实例
export const app = new BaseApplication()
```

## 代码组织

项目的核心代码现在按以下结构组织：

```
src/core/
├── application.ts     # 应用程序核心实现
├── bootstrap.ts       # 应用程序启动器
├── decorators.ts      # 应用程序装饰器
├── helpers.ts         # 工具函数
└── index.ts          # 模块导出
```

这种组织方式的优点：
1. **关注点分离**：每个文件负责特定的功能
2. **可维护性**：更容易定位和修复问题
3. **可测试性**：可以独立测试每个组件
4. **可扩展性**：易于添加新功能
5. **代码复用**：避免代码重复

## 注意事项

1. **环境变量**：
   - `PORT`: 可以通过环境变量覆盖默认端口
   - `DEBUG`: 设置为 true 启用调试模式
   - `NODE_ENV`: 控制运行环境

2. **错误处理**：
   - 生产环境不暴露详细错误信息
   - 开发环境显示完整错误栈
   - 所有错误都被正确记录

3. **性能考虑**：
   - Fastify 服务器配置已优化
   - 请求处理管道经过优化
   - 支持异步操作

## 完成标志
- [ ] 应用程序类功能完整
- [ ] 生命周期管理正常
- [ ] HTTP 服务器集成完成
- [ ] CORS 支持正常工作
- [ ] 所有模块集成正确
- [ ] 请求处理流程正常
- [ ] TypeScript 类型检查无错误

## 下一步
完成此步骤后，继续执行 `07.3-application-bootstrap.md`。 
