# 步骤 08.3：API实现

## 目标
实现用户管理和帖子管理的API，以及认证中间件。

## 任务清单
- [ ] 实现用户管理API
- [ ] 实现帖子管理API
- [ ] 添加认证中间件

## 执行步骤

### 1. 创建类型定义

#### 1.1 用户类型

**创建文件**: `packages/cosy-framework-example/src/types/user.ts`

```typescript
export interface User {
  id: number
  name: string
  email: string
  createdAt: Date
}

export interface CreateUserData {
  name: string
  email: string
}

export interface UpdateUserData {
  name?: string
  email?: string
}
```

#### 1.2 帖子类型

**创建文件**: `packages/cosy-framework-example/src/types/post.ts`

```typescript
export interface Post {
  id: number
  title: string
  content: string
  authorId: number
  createdAt: Date
}

export interface CreatePostData {
  title: string
  content: string
}
```

### 2. 实现认证中间件

**创建文件**: `packages/cosy-framework-example/src/middleware/auth-middleware.ts`

```typescript
import { MiddlewareHandler, HttpStatus } from '@coffic/cosy-framework'

export const AuthMiddleware: MiddlewareHandler = async (context, next) => {
  const authHeader = context.request.header('authorization')
  
  if (!authHeader) {
    return context.response.status(HttpStatus.UNAUTHORIZED).json({
      error: 'Authorization header required'
    })
  }

  // 简单的令牌验证（实际应用中应该使用 JWT 或其他安全机制）
  if (!authHeader.startsWith('Bearer ')) {
    return context.response.status(HttpStatus.UNAUTHORIZED).json({
      error: 'Invalid authorization format. Use: Bearer <token>'
    })
  }

  const token = authHeader.substring(7)
  
  // 模拟令牌验证
  if (token !== 'valid-token') {
    return context.response.status(HttpStatus.UNAUTHORIZED).json({
      error: 'Invalid token'
    })
  }

  // 模拟用户信息（实际应用中应该从令牌中解析）
  ;(context as any).user = {
    id: 1,
    name: 'John Doe',
    email: 'john@example.com'
  }

  return next()
}
```

### 3. 实现用户控制器

**创建文件**: `packages/cosy-framework-example/src/controllers/user-controller.ts`

```typescript
import { Controller, Get, Post, Put, Delete, Inject } from '@coffic/cosy-framework'
import { UserService } from '../services/user-service'

@Controller('/api/v1/users')
export class UserController {
  constructor(@Inject('UserService') private userService: UserService) {}

  @Get('/')
  async index() {
    return this.userService.getUsers()
  }

  @Get('/{id}')
  async show(context: any) {
    const id = parseInt(context.request.params.id)
    return this.userService.getUserById(id)
  }

  @Post('/')
  async create(context: any) {
    const userData = context.request.body
    return this.userService.createUser(userData)
  }

  @Put('/{id}')
  async update(context: any) {
    const id = parseInt(context.request.params.id)
    const userData = context.request.body
    return this.userService.updateUser(id, userData)
  }

  @Delete('/{id}')
  async destroy(context: any) {
    const id = parseInt(context.request.params.id)
    return this.userService.deleteUser(id)
  }
}
```

### 4. 实现帖子控制器

**创建文件**: `packages/cosy-framework-example/src/controllers/post-controller.ts`

```typescript
import { Controller, Get, Post as PostRoute, UseMiddleware, Inject } from '@coffic/cosy-framework'
import { PostService } from '../services/post-service'
import { AuthMiddleware } from '../middleware/auth-middleware'

@Controller('/api/v1/posts')
@UseMiddleware(AuthMiddleware)
export class PostController {
  constructor(@Inject('PostService') private postService: PostService) {}

  @Get('/')
  async index() {
    return this.postService.getPosts()
  }

  @PostRoute('/')
  async create(context: any) {
    const postData = context.request.body
    const userId = context.user?.id
    return this.postService.createPost(postData, userId)
  }
}
```

### 5. API 测试

**创建文件**: `packages/cosy-framework-example/tests/api.test.ts`

```typescript
import { describe, it, expect, beforeAll, afterAll } from 'vitest'
import { startServer } from '../src/server'
import { Application } from '@coffic/cosy-framework'
import { HttpContext, HttpStatus } from '@coffic/cosy-framework/http'

describe('Basic API Integration Tests', () => {
  let app: Application

  beforeAll(async () => {
    app = await startServer()
  })

  afterAll(async () => {
    if (app.isRunning()) {
      await app.stop()
    }
  })

  describe('User API', () => {
    it('should get all users', async () => {
      const context = HttpContext.create({ method: 'GET', url: '/api/v1/users' })
      const response = await app.handle(context.request)

      expect(response.getStatus()).toBe(HttpStatus.OK)
      
      const body = JSON.parse(response.getContent())
      expect(body).toMatchObject({
        users: expect.any(Array),
        total: expect.any(Number)
      })
      expect(body.users.length).toBeGreaterThan(0)
    })

    it('should get user by id', async () => {
      const context = HttpContext.create({ method: 'GET', url: '/api/v1/users/1' })
      const response = await app.handle(context.request)

      expect(response.getStatus()).toBe(HttpStatus.OK)
      
      const body = JSON.parse(response.getContent())
      expect(body).toMatchObject({
        user: {
          id: 1,
          name: expect.any(String),
          email: expect.any(String),
          createdAt: expect.any(String)
        }
      })
    })

    it('should create new user', async () => {
      const userData = {
        name: 'Test User',
        email: 'test@example.com'
      }

      const context = HttpContext.create({
        method: 'POST',
        url: '/api/v1/users',
        body: userData
      })
      const response = await app.handle(context.request)

      expect(response.getStatus()).toBe(HttpStatus.OK)
      
      const body = JSON.parse(response.getContent())
      expect(body).toMatchObject({
        user: {
          id: expect.any(Number),
          name: userData.name,
          email: userData.email,
          createdAt: expect.any(String)
        },
        message: 'User created successfully'
      })
    })
  })

  describe('Post API (Authenticated)', () => {
    it('should require authentication', async () => {
      const context = HttpContext.create({ method: 'GET', url: '/api/v1/posts' })
      const response = await app.handle(context.request)

      expect(response.getStatus()).toBe(HttpStatus.UNAUTHORIZED)
      
      const body = JSON.parse(response.getContent())
      expect(body.error).toContain('Authorization header required')
    })

    it('should get posts with valid token', async () => {
      const context = HttpContext.create({
        method: 'GET',
        url: '/api/v1/posts',
        headers: {
          authorization: 'Bearer valid-token'
        }
      })
      const response = await app.handle(context.request)

      expect(response.getStatus()).toBe(HttpStatus.OK)
      
      const body = JSON.parse(response.getContent())
      expect(body).toMatchObject({
        posts: expect.any(Array),
        total: expect.any(Number)
      })
    })

    it('should create post with valid token', async () => {
      const postData = {
        title: 'Test Post',
        content: 'This is a test post content.'
      }

      const context = HttpContext.create({
        method: 'POST',
        url: '/api/v1/posts',
        headers: {
          authorization: 'Bearer valid-token'
        },
        body: postData
      })
      const response = await app.handle(context.request)

      expect(response.getStatus()).toBe(HttpStatus.OK)
      
      const body = JSON.parse(response.getContent())
      expect(body).toMatchObject({
        post: {
          id: expect.any(Number),
          title: postData.title,
          content: postData.content,
          authorId: expect.any(Number),
          createdAt: expect.any(String)
        },
        message: 'Post created successfully'
      })
    })
  })
})
```

## 完成标志
- [ ] 用户管理API已实现
- [ ] 帖子管理API已实现
- [ ] 认证中间件已实现
- [ ] API测试已实现
- [ ] 所有测试通过

## 下一步
完成此步骤后，继续执行 [08.4-services.md](./08.4-services.md)。 
