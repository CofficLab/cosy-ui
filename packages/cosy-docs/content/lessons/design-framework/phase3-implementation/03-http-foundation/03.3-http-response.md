# 步骤 03.3：HTTP 响应实现

## 目标
实现 HTTP 响应类，提供灵活的响应生成和处理功能。

## 任务清单
- [ ] 实现响应类基本结构
- [ ] 实现状态码管理
- [ ] 实现内容类型处理
- [ ] 实现 Cookie 管理
- [ ] 实现文件下载
- [ ] 实现响应头管理

## 执行步骤

### 1. 创建响应类

**创建文件**: `src/http/response.ts`

```typescript
import { ResponseInterface, CookieOptions, HttpStatus } from '../types'

/**
 * HTTP 响应类
 * 
 * 主要功能：
 * 1. 响应状态管理
 * 2. 内容类型处理
 * 3. Cookie 管理
 * 4. 文件下载支持
 * 5. 链式调用 API
 */
export class Response implements ResponseInterface {
  private statusCode: number = HttpStatus.OK
  private responseHeaders: Record<string, string> = {}
  private cookieData: Array<{ name: string; value: string; options?: CookieOptions }> = []
  private content: any = null
  private isResponded: boolean = false

  /**
   * 设置状态码
   * 
   * @param code HTTP 状态码
   * @returns this 用于链式调用
   */
  status(code: number): ResponseInterface {
    this.statusCode = code
    return this
  }

  /**
   * 发送 JSON 响应
   * 
   * 特点：
   * 1. 自动设置 Content-Type
   * 2. 自动 JSON 序列化
   * 3. 支持美化输出
   */
  json(data: any): ResponseInterface {
    this.header('Content-Type', 'application/json')
    this.content = JSON.stringify(data, null, 2)
    this.isResponded = true
    return this
  }

  /**
   * 发送 HTML 响应
   * 
   * 特点：
   * 1. 自动设置 Content-Type 和字符集
   * 2. 支持 HTML 字符串
   */
  html(content: string): ResponseInterface {
    this.header('Content-Type', 'text/html; charset=utf-8')
    this.content = content
    this.isResponded = true
    return this
  }

  /**
   * 重定向
   * 
   * 特点：
   * 1. 支持自定义状态码
   * 2. 默认使用 302 Found
   */
  redirect(url: string, status: number = HttpStatus.FOUND): ResponseInterface {
    this.status(status)
    this.header('Location', url)
    this.isResponded = true
    return this
  }

  /**
   * 设置 Cookie
   * 
   * 特点：
   * 1. 支持完整的 Cookie 选项
   * 2. 自动生成 Set-Cookie 头
   * 3. 支持安全选项
   */
  cookie(name: string, value: string, options?: CookieOptions): ResponseInterface {
    this.cookieData.push({ name, value, options })
    return this
  }

  /**
   * 清除 Cookie
   * 
   * 原理：
   * 1. 设置过期时间为过去
   * 2. 确保在根路径删除
   */
  clearCookie(name: string): ResponseInterface {
    return this.cookie(name, '', {
      expires: new Date(0),
      path: '/'
    })
  }

  /**
   * 设置响应头
   * 
   * 特点：
   * 1. 支持任意头部设置
   * 2. 自动处理特殊头部
   */
  header(name: string, value: string): ResponseInterface {
    this.responseHeaders[name] = value
    return this
  }

  /**
   * 发送内容
   * 
   * 特点：
   * 1. 支持任意内容类型
   * 2. 自动标记响应完成
   */
  send(content?: any): ResponseInterface {
    if (content !== undefined) {
      this.content = content
    }
    this.isResponded = true
    return this
  }

  /**
   * 下载文件
   * 
   * 特点：
   * 1. 自动设置下载头部
   * 2. 支持自定义文件名
   */
  download(filePath: string, filename?: string): ResponseInterface {
    this.header('Content-Disposition', `attachment; filename="${filename || 'download'}"`)
    this.header('Content-Type', 'application/octet-stream')
    this.content = filePath // 实际实现中这里应该读取文件内容
    this.isResponded = true
    return this
  }

  /**
   * 设置为附件
   * 
   * 特点：
   * 1. 仅设置下载头部
   * 2. 不包含实际内容
   */
  attachment(filename?: string): ResponseInterface {
    if (filename) {
      this.header('Content-Disposition', `attachment; filename="${filename}"`)
    } else {
      this.header('Content-Disposition', 'attachment')
    }
    return this
  }

  // 获取器方法

  /**
   * 获取状态码
   */
  getStatus(): number {
    return this.statusCode
  }

  /**
   * 获取响应头
   */
  getHeaders(): Record<string, string> {
    return { ...this.responseHeaders }
  }

  /**
   * 获取 Cookie 数据
   */
  getCookies(): Array<{ name: string; value: string; options?: CookieOptions }> {
    return [...this.cookieData]
  }

  /**
   * 获取响应内容
   */
  getContent(): any {
    return this.content
  }

  /**
   * 检查是否已响应
   */
  hasResponded(): boolean {
    return this.isResponded
  }

  /**
   * 生成 Set-Cookie 头
   * 
   * 原理：
   * 1. 合并 Cookie 名值对
   * 2. 添加安全选项
   * 3. 处理过期时间
   */
  private generateSetCookieHeader(name: string, value: string, options?: CookieOptions): string {
    let cookieString = `${name}=${value}`

    if (options) {
      if (options.maxAge) {
        cookieString += `; Max-Age=${options.maxAge}`
      }
      if (options.expires) {
        cookieString += `; Expires=${options.expires.toUTCString()}`
      }
      if (options.httpOnly) {
        cookieString += '; HttpOnly'
      }
      if (options.secure) {
        cookieString += '; Secure'
      }
      if (options.sameSite) {
        cookieString += `; SameSite=${options.sameSite}`
      }
      if (options.domain) {
        cookieString += `; Domain=${options.domain}`
      }
      if (options.path) {
        cookieString += `; Path=${options.path}`
      }
    }

    return cookieString
  }

  /**
   * 获取所有 Set-Cookie 头
   */
  getSetCookieHeaders(): string[] {
    return this.cookieData.map(cookie =>
      this.generateSetCookieHeader(cookie.name, cookie.value, cookie.options)
    )
  }
}
```

## 实现说明

### 1. 基本结构
- 实现 `ResponseInterface` 接口
- 内部状态管理
- 链式调用支持

### 2. 状态码管理
- 默认 200 OK
- 支持所有标准状态码
- 状态码验证

### 3. 内容类型处理
- JSON 响应
- HTML 响应
- 原始内容响应
- 自动设置 Content-Type

### 4. Cookie 管理
- 完整的 Cookie 选项支持
- 安全选项处理
- Cookie 删除支持

### 5. 文件下载
- 支持文件附件
- 自定义文件名
- 适当的头部设置

### 6. 响应头管理
- 灵活的头部设置
- 特殊头部处理
- 头部获取接口

## 使用示例

```typescript
// 创建响应实例
const response = new Response()

// JSON 响应
response
  .status(HttpStatus.OK)
  .json({
    id: 1,
    name: 'John Doe',
    email: 'john@example.com'
  })

// HTML 响应
response
  .status(HttpStatus.OK)
  .html('<h1>Welcome</h1>')

// 文件下载
response
  .download('/path/to/file.pdf', 'document.pdf')

// Cookie 设置
response
  .cookie('session', 'abc123', {
    httpOnly: true,
    secure: true,
    maxAge: 3600
  })
  .json({ status: 'success' })
```

## 完成标志
- [ ] 响应类实现完整
- [ ] 所有方法正常工作
- [ ] Cookie 处理正确
- [ ] 文件下载支持完整
- [ ] TypeScript 类型检查无错误

## 下一步
完成此步骤后，继续执行 `03.4-http-context.md`。 
