# 步骤 03.5：HTTP 工具函数

## 目标
实现 HTTP 相关的工具函数，提供常用的辅助功能。

## 任务清单
- [ ] 实现状态码工具
- [ ] 实现内容类型解析
- [ ] 实现 HTTP 方法工具
- [ ] 实现其他辅助函数

## 执行步骤

### 1. 创建工具函数

**创建文件**: `src/http/helpers.ts`

```typescript
import { HttpStatus, HttpMethod } from '../types'

/**
 * 检查是否为成功状态码 (2xx)
 * 
 * 原理：
 * - 状态码范围检查：200-299
 * - 包括常见的成功状态码如 200 OK, 201 Created 等
 */
export function isSuccessStatus(status: number): boolean {
  return status >= 200 && status < 300
}

/**
 * 检查是否为重定向状态码 (3xx)
 * 
 * 原理：
 * - 状态码范围检查：300-399
 * - 包括常见的重定向状态码如 301 Moved Permanently, 302 Found 等
 */
export function isRedirectStatus(status: number): boolean {
  return status >= 300 && status < 400
}

/**
 * 检查是否为客户端错误状态码 (4xx)
 * 
 * 原理：
 * - 状态码范围检查：400-499
 * - 包括常见的客户端错误如 404 Not Found, 400 Bad Request 等
 */
export function isClientErrorStatus(status: number): boolean {
  return status >= 400 && status < 500
}

/**
 * 检查是否为服务器错误状态码 (5xx)
 * 
 * 原理：
 * - 状态码范围检查：500-599
 * - 包括常见的服务器错误如 500 Internal Server Error 等
 */
export function isServerErrorStatus(status: number): boolean {
  return status >= 500 && status < 600
}

/**
 * 获取状态码描述
 * 
 * 特点：
 * 1. 支持所有标准 HTTP 状态码
 * 2. 返回标准描述文本
 * 3. 未知状态码返回 'Unknown Status'
 */
export function getStatusText(status: number): string {
  const statusTexts: Record<number, string> = {
    [HttpStatus.OK]: 'OK',
    [HttpStatus.CREATED]: 'Created',
    [HttpStatus.ACCEPTED]: 'Accepted',
    [HttpStatus.NO_CONTENT]: 'No Content',
    [HttpStatus.MOVED_PERMANENTLY]: 'Moved Permanently',
    [HttpStatus.FOUND]: 'Found',
    [HttpStatus.NOT_MODIFIED]: 'Not Modified',
    [HttpStatus.BAD_REQUEST]: 'Bad Request',
    [HttpStatus.UNAUTHORIZED]: 'Unauthorized',
    [HttpStatus.FORBIDDEN]: 'Forbidden',
    [HttpStatus.NOT_FOUND]: 'Not Found',
    [HttpStatus.METHOD_NOT_ALLOWED]: 'Method Not Allowed',
    [HttpStatus.CONFLICT]: 'Conflict',
    [HttpStatus.UNPROCESSABLE_ENTITY]: 'Unprocessable Entity',
    [HttpStatus.INTERNAL_SERVER_ERROR]: 'Internal Server Error',
    [HttpStatus.NOT_IMPLEMENTED]: 'Not Implemented',
    [HttpStatus.BAD_GATEWAY]: 'Bad Gateway',
    [HttpStatus.SERVICE_UNAVAILABLE]: 'Service Unavailable'
  }

  return statusTexts[status] || 'Unknown Status'
}

/**
 * 解析内容类型
 * 
 * 原理：
 * 1. 分离 MIME 类型和参数
 * 2. 提取字符集信息
 * 3. 规范化结果
 * 
 * 示例：
 * 'text/html; charset=utf-8' ->
 * { type: 'text/html', charset: 'utf-8' }
 */
export function parseContentType(contentType: string): { type: string; charset?: string } {
  const parts = contentType.split(';')
  const type = parts[0].trim()
  const charset = parts.find(p => p.trim().startsWith('charset='))?.split('=')[1]?.trim()
  
  return { type, charset }
}

/**
 * 判断是否为安全 HTTP 方法
 * 
 * 原理：
 * - 安全方法不应修改服务器状态
 * - 包括 GET, HEAD, OPTIONS
 */
export function isSafeMethod(method: string): boolean {
  return [HttpMethod.GET, HttpMethod.HEAD, HttpMethod.OPTIONS].includes(method as HttpMethod)
}

/**
 * 判断是否为幂等 HTTP 方法
 * 
 * 原理：
 * - 幂等方法的多次调用效果相同
 * - 包括 GET, HEAD, PUT, DELETE, OPTIONS
 */
export function isIdempotentMethod(method: string): boolean {
  return [
    HttpMethod.GET,
    HttpMethod.HEAD,
    HttpMethod.PUT,
    HttpMethod.DELETE,
    HttpMethod.OPTIONS
  ].includes(method as HttpMethod)
}

/**
 * 规范化头部名称
 * 
 * 原理：
 * 1. 转换为标准格式
 * 2. 处理特殊情况
 * 
 * 示例：
 * 'content-type' -> 'Content-Type'
 */
export function normalizeHeaderName(name: string): string {
  return name.split('-')
    .map(part => part.charAt(0).toUpperCase() + part.slice(1).toLowerCase())
    .join('-')
}

/**
 * 解析 Accept 头部
 * 
 * 原理：
 * 1. 分割多个 MIME 类型
 * 2. 提取权重信息
 * 3. 按权重排序
 * 
 * 示例：
 * 'text/html,application/json;q=0.9' ->
 * [{ type: 'text/html', q: 1 }, { type: 'application/json', q: 0.9 }]
 */
export function parseAcceptHeader(accept: string): Array<{ type: string; q: number }> {
  return accept.split(',')
    .map(part => {
      const [type, ...params] = part.trim().split(';')
      const q = params.find(p => p.startsWith('q='))
        ? parseFloat(params.find(p => p.startsWith('q='))!.split('=')[1])
        : 1
      return { type: type.trim(), q }
    })
    .sort((a, b) => b.q - a.q)
}
```

## 实现说明

### 1. 状态码工具
- 状态码范围检查
- 状态码描述获取
- 错误类型判断

### 2. 内容类型工具
- MIME 类型解析
- 字符集提取
- Accept 头部解析

### 3. HTTP 方法工具
- 安全方法判断
- 幂等方法判断
- 方法验证

### 4. 头部处理工具
- 头部名称规范化
- 头部值解析
- 特殊头部处理

## 使用示例

```typescript
// 状态码工具
console.log(isSuccessStatus(200))         // true
console.log(isClientErrorStatus(404))     // true
console.log(getStatusText(200))           // 'OK'

// 内容类型解析
const { type, charset } = parseContentType('text/html; charset=utf-8')
console.log(type)                         // 'text/html'
console.log(charset)                      // 'utf-8'

// HTTP 方法工具
console.log(isSafeMethod('GET'))         // true
console.log(isIdempotentMethod('PUT'))   // true

// Accept 头部解析
const accepts = parseAcceptHeader('text/html,application/json;q=0.9')
console.log(accepts)
// [
//   { type: 'text/html', q: 1 },
//   { type: 'application/json', q: 0.9 }
// ]

// 头部名称规范化
console.log(normalizeHeaderName('content-type'))  // 'Content-Type'
```

## 完成标志
- [ ] 所有工具函数实现完整
- [ ] 函数行为符合 HTTP 规范
- [ ] 边界情况处理正确
- [ ] 代码注释完整
- [ ] TypeScript 类型检查无错误

## 下一步
完成此步骤后，继续执行 `03.6-http-testing.md`。 
