# 步骤 08.1：项目结构和最佳实践

## 目标
建立一个清晰的项目结构，并定义开发最佳实践。

## 任务清单
- [ ] 创建项目目录结构
- [ ] 设置开发环境
- [ ] 定义最佳实践指南

## 执行步骤

### 1. 创建项目目录结构

在项目根目录创建示例项目：

```bash
mkdir -p packages/cosy-framework-example/src/{controllers,services,middleware,types}
```

项目结构：
```
src/
├── controllers/     # 控制器
├── services/       # 业务逻辑服务
├── middleware/     # 自定义中间件
├── types/         # TypeScript 类型定义
├── app.ts         # 应用配置和路由定义
└── server.ts      # 服务器启动入口

config/            # 配置文件
├── app.json       # 基础配置
├── development.json # 开发环境配置
└── production.json  # 生产环境配置

tests/            # 测试文件
└── api.test.ts   # API 测试

scripts/          # 脚本文件
├── start.sh      # 生产环境启动脚本
└── dev.sh        # 开发环境启动脚本
```

### 2. 设置开发环境

#### 2.1 创建包配置

**创建文件**: `packages/cosy-framework-example/package.json`

```json
{
  "name": "cosy-framework-basic-api",
  "version": "1.0.0",
  "description": "Basic API example using Cosy Framework",
  "main": "dist/server.js",
  "scripts": {
    "build": "tsc",
    "start": "node dist/server.js",
    "dev": "tsx watch src/server.ts",
    "test": "vitest",
    "test:api": "tsx tests/api.test.ts"
  },
  "dependencies": {
    "@coffic/cosy-framework": "workspace:*"
  },
  "devDependencies": {
    "typescript": "^5.3.0",
    "tsx": "^4.0.0",
    "vitest": "^1.0.0",
    "@types/node": "^20.0.0"
  }
}
```

#### 2.2 创建 TypeScript 配置

**创建文件**: `packages/cosy-framework-example/tsconfig.json`

```json
{
  "extends": "../../tsconfig.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "include": [
    "src/**/*"
  ],
  "exclude": [
    "node_modules",
    "dist",
    "tests"
  ]
}
```

#### 2.3 创建环境变量文件

**创建文件**: `packages/cosy-framework-example/.env.example`

```env
# 应用配置
NODE_ENV=development
PORT=3000
APP_NAME="Basic API Example"
APP_DEBUG=true

# CORS 配置
CORS_ORIGIN=*

# 认证配置
JWT_SECRET=your-super-secret-key
JWT_EXPIRES_IN=24h

# 数据库配置（示例）
DATABASE_URL=postgres://localhost:5432/cosy_app
REDIS_URL=redis://localhost:6379
```

### 3. 最佳实践指南

#### 3.1 应用架构
1. **职责分离**：
   - `app.ts` 负责应用配置、服务注册、路由定义
   - `server.ts` 负责应用启动和错误处理

2. **启动流程**：
   ```typescript
   // 1. 创建应用实例
   const app = Application.create({...})
   
   // 2. 注册服务
   app.bind('ServiceName', ServiceClass)
   
   // 3. 配置中间件
   app.middleware('name', MiddlewareClass)
   
   // 4. 定义路由
   app.group('/api/v1', (api) => {...})
   
   // 5. 启动应用
   await app.boot()
   await app.start()
   ```

#### 3.2 导入规范
1. 从主模块导入所有内容：
   ```typescript
   import { 
       Application, 
       gracefulShutdown, 
       setupErrorHandling,
       cors,
       logger,
       errorHandler,
       type HttpContextInterface
   } from '@coffic/cosy-framework'
   ```

2. 不要从子模块导入：
   ```typescript
   // ❌ 错误的导入方式
   import { cors, logger } from '@coffic/cosy-framework/middleware'
   
   // ✅ 正确的导入方式
   import { cors, logger } from '@coffic/cosy-framework'
   ```

3. 始终为回调函数参数添加类型注解：
   ```typescript
   // ❌ 错误的类型推断
   app.use(logger({
       skip: (context) => context.request.path === '/health'
   }))
   
   // ✅ 正确的类型注解
   app.use(logger({
       skip: (context: HttpContextInterface) => context.request.path === '/health'
   }))
   ```

#### 3.3 配置管理
1. **配置优先级**：
   - 环境变量 > 环境特定配置文件 > 基础配置文件 > 默认值

2. **配置文件组织**：
   - `app.json`: 基础配置
   - `development.json`: 开发环境配置
   - `production.json`: 生产环境配置

3. **敏感信息**：
   - 不要在配置文件中存储敏感信息
   - 使用环境变量或加密配置

#### 3.4 错误处理
1. **全局错误处理**：
   - 使用 `setupErrorHandling` 设置全局错误处理器
   - 记录错误日志
   - 返回适当的错误响应

2. **优雅关闭**：
   - 使用 `gracefulShutdown` 处理进程信号
   - 确保资源正确释放
   - 等待所有请求完成

## 完成标志
- [ ] 项目目录结构已创建
- [ ] 开发环境配置完成
- [ ] 最佳实践文档完整
- [ ] TypeScript 配置正确
- [ ] 环境变量文件已创建

## 下一步
完成此步骤后，继续执行 [08.2-application-setup.md](./08.2-application-setup.md)。 
