# 步骤 08.4：服务层实现

## 目标
实现用户服务和帖子服务，处理业务逻辑。

## 任务清单
- [ ] 实现用户服务
- [ ] 实现帖子服务
- [ ] 定义数据类型

## 执行步骤

### 1. 实现用户服务

**创建文件**: `packages/cosy-framework-example/src/services/user-service.ts`

```typescript
import { Injectable } from '@coffic/cosy-framework'
import { User, CreateUserData, UpdateUserData } from '../types/user'

@Injectable
export class UserService {
  private users: User[] = [
    { id: 1, name: 'John Doe', email: 'john@example.com', createdAt: new Date('2024-01-01') },
    { id: 2, name: 'Jane Smith', email: 'jane@example.com', createdAt: new Date('2024-01-02') }
  ]

  private nextId = 3

  /**
   * 获取所有用户
   */
  getUsers(): { users: User[]; total: number } {
    return {
      users: this.users,
      total: this.users.length
    }
  }

  /**
   * 根据 ID 获取用户
   */
  getUserById(id: number): { user: User | null } {
    const user = this.users.find(u => u.id === id)
    if (!user) {
      throw new Error('User not found')
    }
    return { user }
  }

  /**
   * 创建用户
   */
  createUser(userData: CreateUserData): { user: User; message: string } {
    // 验证邮箱是否已存在
    if (this.users.some(u => u.email === userData.email)) {
      throw new Error('Email already exists')
    }

    const user: User = {
      id: this.nextId++,
      name: userData.name,
      email: userData.email,
      createdAt: new Date()
    }

    this.users.push(user)

    return {
      user,
      message: 'User created successfully'
    }
  }

  /**
   * 更新用户
   */
  updateUser(id: number, userData: UpdateUserData): { user: User; message: string } {
    const userIndex = this.users.findIndex(u => u.id === id)
    if (userIndex === -1) {
      throw new Error('User not found')
    }

    // 检查邮箱是否被其他用户使用
    if (userData.email && this.users.some(u => u.id !== id && u.email === userData.email)) {
      throw new Error('Email already exists')
    }

    const user = this.users[userIndex]
    this.users[userIndex] = {
      ...user,
      ...userData,
      id: user.id, // 保持 ID 不变
      createdAt: user.createdAt // 保持创建时间不变
    }

    return {
      user: this.users[userIndex],
      message: 'User updated successfully'
    }
  }

  /**
   * 删除用户
   */
  deleteUser(id: number): { message: string } {
    const userIndex = this.users.findIndex(u => u.id === id)
    if (userIndex === -1) {
      throw new Error('User not found')
    }

    this.users.splice(userIndex, 1)

    return {
      message: 'User deleted successfully'
    }
  }

  /**
   * 根据邮箱获取用户（用于认证）
   */
  getUserByEmail(email: string): User | null {
    return this.users.find(u => u.email === email) || null
  }
}
```

### 2. 实现帖子服务

**创建文件**: `packages/cosy-framework-example/src/services/post-service.ts`

```typescript
import { Injectable } from '@coffic/cosy-framework'
import { Post, CreatePostData } from '../types/post'

@Injectable
export class PostService {
  private posts: Post[] = [
    {
      id: 1,
      title: 'Welcome to Cosy Framework',
      content: 'This is a sample post using the Cosy Framework.',
      authorId: 1,
      createdAt: new Date('2024-01-01')
    }
  ]

  private nextId = 2

  /**
   * 获取所有文章
   */
  getPosts(): { posts: Post[]; total: number } {
    return {
      posts: this.posts,
      total: this.posts.length
    }
  }

  /**
   * 根据 ID 获取文章
   */
  getPostById(id: number): { post: Post | null } {
    const post = this.posts.find(p => p.id === id)
    if (!post) {
      throw new Error('Post not found')
    }
    return { post }
  }

  /**
   * 创建文章
   */
  createPost(postData: CreatePostData, authorId: number): { post: Post; message: string } {
    const post: Post = {
      id: this.nextId++,
      title: postData.title,
      content: postData.content,
      authorId,
      createdAt: new Date()
    }

    this.posts.push(post)

    return {
      post,
      message: 'Post created successfully'
    }
  }

  /**
   * 获取用户的文章
   */
  getPostsByUserId(userId: number): { posts: Post[]; total: number } {
    const userPosts = this.posts.filter(p => p.authorId === userId)
    return {
      posts: userPosts,
      total: userPosts.length
    }
  }
}
```

### 3. 服务层测试

**创建文件**: `packages/cosy-framework-example/tests/services.test.ts`

```typescript
import { describe, it, expect } from 'vitest'
import { UserService } from '../src/services/user-service'
import { PostService } from '../src/services/post-service'

describe('User Service', () => {
  let userService: UserService

  beforeEach(() => {
    userService = new UserService()
  })

  it('should get all users', () => {
    const result = userService.getUsers()
    expect(result.users.length).toBeGreaterThan(0)
    expect(result.total).toBe(result.users.length)
  })

  it('should create user', () => {
    const userData = {
      name: 'Test User',
      email: 'test@example.com'
    }

    const result = userService.createUser(userData)
    expect(result.user).toMatchObject({
      id: expect.any(Number),
      name: userData.name,
      email: userData.email,
      createdAt: expect.any(Date)
    })
  })

  it('should not create user with duplicate email', () => {
    const userData = {
      name: 'John Doe',
      email: 'john@example.com'
    }

    expect(() => userService.createUser(userData)).toThrow('Email already exists')
  })
})

describe('Post Service', () => {
  let postService: PostService

  beforeEach(() => {
    postService = new PostService()
  })

  it('should get all posts', () => {
    const result = postService.getPosts()
    expect(result.posts.length).toBeGreaterThan(0)
    expect(result.total).toBe(result.posts.length)
  })

  it('should create post', () => {
    const postData = {
      title: 'Test Post',
      content: 'This is a test post.'
    }

    const result = postService.createPost(postData, 1)
    expect(result.post).toMatchObject({
      id: expect.any(Number),
      title: postData.title,
      content: postData.content,
      authorId: 1,
      createdAt: expect.any(Date)
    })
  })

  it('should get posts by user id', () => {
    const result = postService.getPostsByUserId(1)
    expect(result.posts.every(post => post.authorId === 1)).toBe(true)
  })
})
```

## 完成标志
- [ ] 用户服务已实现
- [ ] 帖子服务已实现
- [ ] 服务层测试已实现
- [ ] 所有测试通过
- [ ] 代码文档完整

## 下一步
完成此步骤后，继续执行 [08.5-testing-docs.md](./08.5-testing-docs.md)。 
