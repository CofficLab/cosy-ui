# 步骤 03.6：HTTP 测试实现

## 目标
创建完整的测试套件，确保 HTTP 基础设施的正确性和可靠性。

## 任务清单
- [ ] 创建请求测试
- [ ] 创建响应测试
- [ ] 创建上下文测试
- [ ] 创建工具函数测试
- [ ] 创建集成测试
- [ ] 创建手动测试脚本

## 执行步骤

### 1. 创建单元测试

**创建文件**: `tests/unit/http.test.ts`

```typescript
import { describe, it, expect } from 'vitest'
import {
  Request,
  Response,
  HttpContext,
  HttpStatus,
  HttpMethod,
  isSuccessStatus,
  isClientErrorStatus,
  parseContentType,
  parseAcceptHeader
} from '../../src/http'

describe('HTTP Foundation', () => {
  describe('Request', () => {
    it('should create request with basic data', () => {
      const request = new Request({
        method: 'POST',
        url: 'https://example.com/api/users?page=1',
        headers: { 'content-type': 'application/json' },
        body: { name: 'John' },
        query: { page: '1' }
      })

      expect(request.method).toBe('POST')
      expect(request.path).toBe('/api/users')
      expect(request.query.page).toBe('1')
      expect(request.body.name).toBe('John')
      expect(request.header('content-type')).toBe('application/json')
    })

    it('should handle input data correctly', () => {
      const request = new Request({
        method: 'POST',
        url: '/test',
        body: { name: 'John', age: 30 },
        query: { filter: 'active' }
      })

      expect(request.input('name')).toBe('John')
      expect(request.input('filter')).toBe('active')
      expect(request.input('missing', 'default')).toBe('default')
      expect(request.has('name')).toBe(true)
      expect(request.has('missing')).toBe(false)
    })

    it('should detect request types', () => {
      const jsonRequest = new Request({
        method: 'POST',
        url: '/test',
        headers: { 'content-type': 'application/json' }
      })

      const formRequest = new Request({
        method: 'POST',
        url: '/test',
        headers: { 'content-type': 'application/x-www-form-urlencoded' }
      })

      const ajaxRequest = new Request({
        method: 'GET',
        url: '/test',
        headers: { 'x-requested-with': 'XMLHttpRequest' }
      })

      expect(jsonRequest.isJson()).toBe(true)
      expect(formRequest.isForm()).toBe(true)
      expect(ajaxRequest.isAjax()).toBe(true)
    })
  })

  describe('Response', () => {
    it('should create JSON response', () => {
      const response = new Response()
      response.status(HttpStatus.CREATED).json({ id: 1, name: 'John' })

      expect(response.getStatus()).toBe(HttpStatus.CREATED)
      expect(response.getHeaders()['Content-Type']).toBe('application/json')
      expect(response.getContent()).toContain('"name": "John"')
      expect(response.hasResponded()).toBe(true)
    })

    it('should create HTML response', () => {
      const response = new Response()
      response.html('<h1>Hello World</h1>')

      expect(response.getHeaders()['Content-Type']).toBe('text/html; charset=utf-8')
      expect(response.getContent()).toBe('<h1>Hello World</h1>')
    })

    it('should handle redirects', () => {
      const response = new Response()
      response.redirect('/home', HttpStatus.MOVED_PERMANENTLY)

      expect(response.getStatus()).toBe(HttpStatus.MOVED_PERMANENTLY)
      expect(response.getHeaders()['Location']).toBe('/home')
    })

    it('should handle cookies', () => {
      const response = new Response()
      response.cookie('session', 'abc123', { httpOnly: true, maxAge: 3600 })
      response.clearCookie('old-session')

      const cookies = response.getCookies()
      expect(cookies).toHaveLength(2)
      expect(cookies[0].name).toBe('session')
      expect(cookies[0].value).toBe('abc123')
      expect(cookies[1].name).toBe('old-session')
      expect(cookies[1].value).toBe('')

      const setCookieHeaders = response.getSetCookieHeaders()
      expect(setCookieHeaders[0]).toContain('session=abc123')
      expect(setCookieHeaders[0]).toContain('HttpOnly')
      expect(setCookieHeaders[0]).toContain('Max-Age=3600')
    })
  })

  describe('HttpContext', () => {
    it('should create context from request and response', () => {
      const request = new Request({
        method: 'GET',
        url: '/test'
      })
      const response = new Response()
      const context = new HttpContext(request, response)

      expect(context.request).toBe(request)
      expect(context.response).toBe(response)
    })

    it('should create context with factory method', () => {
      const context = HttpContext.create({
        method: 'POST',
        url: '/api/test',
        body: { data: 'test' }
      })

      expect(context.request.method).toBe('POST')
      expect(context.request.path).toBe('/api/test')
      expect(context.request.body.data).toBe('test')
      expect(context.response).toBeDefined()
    })

    it('should provide convenient methods', () => {
      const context = HttpContext.create({
        method: 'POST',
        url: '/api/test',
        body: { name: 'John' }
      })

      context.json({ success: true })

      expect(context.getMethod()).toBe('POST')
      expect(context.getPath()).toBe('/api/test')
      expect(context.input('name')).toBe('John')
      expect(context.getStatus()).toBe(HttpStatus.OK)
      expect(context.hasResponded()).toBe(true)
    })
  })

  describe('Helper Functions', () => {
    it('should check status codes', () => {
      expect(isSuccessStatus(200)).toBe(true)
      expect(isSuccessStatus(404)).toBe(false)
      expect(isClientErrorStatus(404)).toBe(true)
      expect(isClientErrorStatus(200)).toBe(false)
    })

    it('should parse content type', () => {
      const result = parseContentType('text/html; charset=utf-8')
      expect(result.type).toBe('text/html')
      expect(result.charset).toBe('utf-8')
    })

    it('should parse accept header', () => {
      const accepts = parseAcceptHeader('text/html,application/json;q=0.9')
      expect(accepts).toHaveLength(2)
      expect(accepts[0].type).toBe('text/html')
      expect(accepts[0].q).toBe(1)
      expect(accepts[1].type).toBe('application/json')
      expect(accepts[1].q).toBe(0.9)
    })
  })
})
```

### 2. 创建手动测试脚本

**创建文件**: `tests/manual-http-test.ts`

```typescript
import {
  Request,
  Response,
  HttpContext,
  HttpStatus,
  HttpMethod,
  isSuccessStatus,
  parseContentType
} from '../src/http'

console.log('=== HTTP 基础设施测试 ===')

// 1. 请求测试
console.log('\n1. 请求测试')

const request = new Request({
  method: 'POST',
  url: '/api/users?filter=active',
  headers: {
    'content-type': 'application/json',
    'x-api-key': 'secret'
  },
  body: {
    name: 'John Doe',
    email: 'john@example.com'
  }
})

console.log('请求方法:', request.method)
console.log('请求路径:', request.path)
console.log('查询参数:', request.query)
console.log('请求体:', request.body)
console.log('Content-Type:', request.header('content-type'))
console.log('是否 JSON:', request.isJson())

// 2. 响应测试
console.log('\n2. 响应测试')

const response = new Response()
response
  .status(HttpStatus.CREATED)
  .cookie('session', 'abc123', { httpOnly: true })
  .json({
    id: 1,
    name: 'John Doe',
    email: 'john@example.com'
  })

console.log('响应状态:', response.getStatus())
console.log('响应头:', response.getHeaders())
console.log('Cookie:', response.getCookies())
console.log('响应内容:', response.getContent())

// 3. 上下文测试
console.log('\n3. 上下文测试')

const context = HttpContext.create({
  method: 'POST',
  url: '/api/users',
  headers: {
    'content-type': 'application/json'
  },
  body: {
    name: 'Jane Smith',
    email: 'jane@example.com'
  }
})

context.json({
  success: true,
  data: {
    id: 2,
    ...context.request.body
  }
})

console.log('上下文方法:', context.getMethod())
console.log('上下文路径:', context.getPath())
console.log('输入数据:', context.input())
console.log('响应状态:', context.getStatus())
console.log('是否已响应:', context.hasResponded())

// 4. 工具函数测试
console.log('\n4. 工具函数测试')

console.log('200 是成功状态码:', isSuccessStatus(200))
console.log('解析内容类型:', parseContentType('text/html; charset=utf-8'))

// 5. 文件上传测试
console.log('\n5. 文件上传测试')

const uploadRequest = new Request({
  method: 'POST',
  url: '/api/upload',
  headers: {
    'content-type': 'multipart/form-data'
  },
  files: {
    'document': [{
      fieldname: 'document',
      originalname: 'test.pdf',
      encoding: '7bit',
      mimetype: 'application/pdf',
      size: 12345
    }]
  }
})

console.log('上传文件:', uploadRequest.file('document'))
console.log('是否为表单:', uploadRequest.isForm())

// 6. 错误处理测试
console.log('\n6. 错误处理测试')

const errorResponse = new Response()
errorResponse
  .status(HttpStatus.BAD_REQUEST)
  .json({
    error: 'Invalid input',
    message: 'Name is required'
  })

console.log('错误状态:', errorResponse.getStatus())
console.log('错误内容:', errorResponse.getContent())

console.log('\n=== HTTP 基础设施测试完成 ===')
```

### 3. 运行测试

```bash
# 运行单元测试
npm test tests/unit/http.test.ts

# 运行手动测试
npx tsx tests/manual-http-test.ts
```

## 测试覆盖范围

### 1. 请求测试
- 基本数据处理
- 输入数据处理
- 请求类型检测
- 文件上传处理

### 2. 响应测试
- JSON 响应
- HTML 响应
- 重定向
- Cookie 处理
- 文件下载

### 3. 上下文测试
- 创建方法
- 工厂方法
- 便捷方法
- 状态管理

### 4. 工具函数测试
- 状态码检查
- 内容类型解析
- Accept 头部解析
- 头部处理

### 5. 集成测试
- 完整请求-响应流程
- 文件上传和下载
- 错误处理
- Cookie 和会话

## 完成标志
- [ ] 所有单元测试通过
- [ ] 手动测试脚本运行成功
- [ ] 测试覆盖率达到目标
- [ ] 所有核心功能都有测试
- [ ] 错误处理测试完整
- [ ] TypeScript 类型检查无错误

## 下一步
完成此步骤后，继续执行 `step-004-routing-system.md`。 
