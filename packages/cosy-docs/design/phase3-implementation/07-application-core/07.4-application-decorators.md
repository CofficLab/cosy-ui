# 步骤 007.4：应用程序装饰器

## 目标
实现应用程序相关的装饰器，提供声明式的应用程序配置和生命周期管理。

## 任务清单
- [ ] 实现应用程序装饰器
- [ ] 实现自动注册装饰器
- [ ] 实现生命周期装饰器
- [ ] 实现应用程序工厂

## 执行步骤

### 1. 创建装饰器

**创建文件**: `src/core/decorators.ts`

```typescript
import 'reflect-metadata'
import { ApplicationInterface, Constructor } from '../types'

// 元数据键
const APP_METADATA = Symbol('app')
const CONTROLLER_METADATA = Symbol('controller')

/**
 * 应用程序装饰器
 */
export function App(config?: any) {
  return function <T extends Constructor>(target: T) {
    Reflect.defineMetadata(APP_METADATA, config || {}, target)
    return target
  }
}

/**
 * 自动注册控制器装饰器
 */
export function AutoRegister() {
  return function <T extends Constructor>(target: T) {
    Reflect.defineMetadata(CONTROLLER_METADATA, true, target)
    return target
  }
}

/**
 * 获取应用程序元数据
 */
export function getAppMetadata(target: any): any {
  return Reflect.getMetadata(APP_METADATA, target)
}

/**
 * 检查是否需要自动注册
 */
export function shouldAutoRegister(target: any): boolean {
  return Reflect.getMetadata(CONTROLLER_METADATA, target) === true
}

/**
 * 启动装饰器（方法装饰器）
 */
export function OnStart() {
  return function (target: any, propertyKey: string, descriptor: PropertyDescriptor) {
    Reflect.defineMetadata('lifecycle:start', true, target, propertyKey)
    return descriptor
  }
}

/**
 * 停止装饰器（方法装饰器）
 */
export function OnStop() {
  return function (target: any, propertyKey: string, descriptor: PropertyDescriptor) {
    Reflect.defineMetadata('lifecycle:stop', true, target, propertyKey)
    return descriptor
  }
}

/**
 * 应用程序工厂
 */
export function createApp(AppClass: Constructor<any>): ApplicationInterface {
  const config = getAppMetadata(AppClass)
  const app = new AppClass()
  
  // 这里可以根据装饰器配置应用程序
  // 实际实现需要更复杂的逻辑
  
  return app
}
```

### 2. 使用示例

```typescript
import { App, AutoRegister, OnStart, OnStop } from '@coffic/cosy-framework'

@App({
  name: 'My Application',
  port: 3000,
  debug: true
})
class MyApp {
  @OnStart()
  async start() {
    console.log('Application starting...')
  }

  @OnStop()
  async stop() {
    console.log('Application stopping...')
  }
}

@AutoRegister()
class UserController {
  // 控制器实现
}
```

### 3. 工具函数

**创建文件**: `src/core/helpers.ts`

```typescript
import { Application } from './index'
import { ApplicationConfig } from '../types'

/**
 * 创建简单的 Web 应用
 */
export function createWebApp(config?: ApplicationConfig): Application {
  const app = Application.create(config)
  
  // 添加常用中间件
  // app.use(cors())
  // app.use(logger())
  // app.use(bodyParser())
  
  return app
}

/**
 * 创建 API 应用
 */
export function createApiApp(config?: ApplicationConfig): Application {
  const app = Application.create({
    ...config,
    name: config?.name || 'API Application'
  })
  
  // API 特定的中间件和配置
  // app.use(cors({ origin: '*' }))
  // app.use(apiMiddleware())
  
  return app
}

/**
 * 优雅关闭处理
 */
export function gracefulShutdown(app: Application): void {
  const signals = ['SIGTERM', 'SIGINT', 'SIGUSR2']
  
  signals.forEach(signal => {
    process.on(signal, async () => {
      console.log(`Received ${signal}, shutting down gracefully...`)
      
      try {
        await app.stop()
        process.exit(0)
      } catch (error) {
        console.error('Error during shutdown:', error)
        process.exit(1)
      }
    })
  })
}

/**
 * 错误处理设置
 */
export function setupErrorHandling(app: Application): void {
  process.on('unhandledRejection', (reason, promise) => {
    console.error('Unhandled Rejection at:', promise, 'reason:', reason)
    // 这里可以添加更复杂的错误处理逻辑
  })

  process.on('uncaughtException', (error) => {
    console.error('Uncaught Exception:', error)
    // 优雅关闭
    app.stop().finally(() => {
      process.exit(1)
    })
  })
}
```

## 装饰器功能说明

1. **@App**
   - 用于配置应用程序
   - 支持所有 ApplicationConfig 选项
   - 可以在类级别使用

2. **@AutoRegister**
   - 用于自动注册控制器
   - 在应用启动时自动扫描和注册
   - 可以在类级别使用

3. **@OnStart/@OnStop**
   - 用于定义生命周期钩子
   - 在应用启动/停止时自动调用
   - 可以在方法级别使用

## 完成标志
- [ ] 所有装饰器功能完整
- [ ] 元数据处理正确
- [ ] 生命周期钩子正常工作
- [ ] 自动注册功能正常
- [ ] TypeScript 类型检查无错误

## 下一步
完成此步骤后，继续执行 `07.5-application-testing.md`。 
