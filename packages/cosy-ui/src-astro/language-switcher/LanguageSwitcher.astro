---
/**
 * @component LanguageSwitcher
 *
 * @description
 * LanguageSwitcher 组件提供一个语言切换下拉菜单，支持多语言网站的语言切换功能。
 * 组件会自动处理 URL 路径，确保在切换语言时保留当前页面路径。
 *
 * @design
 * 设计理念：
 * 1. 简洁直观 - 清晰显示当前语言和可选语言
 * 2. 无缝集成 - 自动处理 URL 路由，保持用户浏览上下文
 * 3. 可定制性 - 支持自定义语言列表和当前语言设置
 * 4. 一致的视觉风格 - 使用与整体设计系统一致的下拉菜单样式
 *
 * @usage
 * 基本用法：
 * ```astro
 * <LanguageSwitcher />
 * ```
 *
 */

import {
  ChevronDownIcon,
  LanguageUtil,
  Link,
  ListItem,
} from '../../index-astro';
import '../../style.ts';

interface Props {
  /**
   * 自定义类名
   */
  class?: string;
}

const { class: className = '' } = Astro.props;

let links: any[] = [];
let currentLocale: string | undefined = undefined;
let currentLanguageName: string | undefined = undefined;
let isI18nEnabled = false;

// 动态检查 i18n 是否启用，避免构建时被 Vite 扫描
try {
  // 通过动态构造模块名来避免静态分析
  const configModuleName = 'astro' + ':' + 'config/server';
  const astroConfig = await import(/* @vite-ignore */ configModuleName);
  isI18nEnabled = astroConfig.i18n !== undefined;
} catch (error) {
  console.warn(
    'LanguageSwitcher: Unable to load astro:config/server module. i18n might not be enabled.'
  );
  isI18nEnabled = false;
}

if (isI18nEnabled) {
  const { getSwitcherLinks } = await import('./switcher_util.ts');
  links = await getSwitcherLinks(Astro);

  currentLocale = Astro.currentLocale!;
  currentLanguageName = LanguageUtil.getLanguageName(currentLocale);
} else {
  console.warn(
    'LanguageSwitcher: i18n is not enabled in Astro config. Component will not render.'
  );
}
---

{
  isI18nEnabled && (
    <div class={`cosy:dropdown cosy:dropdown-end ${className}`}>
      <div tabindex="0" role="button" class:list={['cosy:btn cosy:btn-ghost']}>
        <span class="cosy:mr-1">{currentLanguageName}</span>
        <ChevronDownIcon size="16px" class="cosy:w-4 cosy:h-4" />
      </div>
      <ul
        tabindex="0"
        class="cosy:z-[1] cosy:bg-base-100 cosy:shadow cosy:p-2 cosy:rounded-box cosy:w-32 cosy:dropdown-content cosy:menu">
        {links.map((link) => (
          <ListItem>
            <Link href={link.url} active={currentLocale === link.locale}>
              {link.name}
            </Link>
          </ListItem>
        ))}
      </ul>
    </div>
  )
}
